<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buddy AI - Production</title>
  <script src="https://js.puter.com/v2/"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #1d232c;
      --accent-primary: #6aa6ff;
      --accent-secondary: #9b6bff;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --border: #30363d;
      --success: #3ad29f;
      --warning: #ffcc66;
      --error: #ff6b6b;
      --control-height: 44px;
      --sidebar-width: 280px;
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      overflow: hidden;
      background-image: 
        radial-gradient(ellipse at 10% -10%, rgba(106, 166, 255, 0.1), transparent 50%),
        radial-gradient(ellipse at 90% -20%, rgba(155, 107, 255, 0.08), transparent 50%);
      line-height: 1.6;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      z-index: 100;
      transition: var(--transition);
      position: relative;
    }

    .sidebar-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 20px;
      color: var(--text-primary);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-sidebar {
      display: none;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .btn {
      padding: 12px;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      width: 100%;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      margin-bottom: 8px;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .conversation-item {
      padding: 12px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-tertiary);
      border: 1px solid transparent;
    }

    .conversation-item.active {
      background: rgba(106, 166, 255, 0.15);
      border-color: var(--accent-primary);
    }

    .conversation-item:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    .conversation-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .conversation-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-actions {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .conversation-item:hover .conversation-actions {
      opacity: 1;
    }

    .action-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .action-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }

    .topbar {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(22, 27, 34, 0.8);
      backdrop-filter: blur(8px);
      z-index: 10;
    }

    .toggle-sidebar {
      display: none;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
    }

    .current-conversation {
      font-weight: 600;
      font-size: 18px;
      flex: 1;
    }

    .topbar-actions {
      display: flex;
      gap: 12px;
    }

    .topbar-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .topbar-btn:hover {
      background: rgba(106, 166, 255, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 20px;
    }

    .empty-state-icon {
      font-size: 48px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .message {
      max-width: 800px;
      width: 100%;
      display: flex;
      gap: 16px;
      padding: 20px;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      animation: fadeIn 0.3s ease;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      border-left: 3px solid var(--accent-primary);
    }

    .message.assistant {
      border-left: 3px solid var(--success);
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .user .avatar {
      background: rgba(106, 166, 255, 0.15);
      color: var(--accent-primary);
    }

    .assistant .avatar {
      background: rgba(58, 210, 159, 0.15);
      color: var(--success);
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message-time {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: normal;
    }

    .message-body {
      line-height: 1.6;
    }

    .message-body pre {
      background: rgba(16, 20, 26, 0.8);
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      margin: 12px 0;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      border: 1px solid var(--border);
      line-height: 1.5;
    }

    .message-body code {
      background: rgba(106, 166, 255, 0.1);
      color: var(--accent-primary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
    }

    .message-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    .action-btn {
      background: var(--bg-tertiary);
    }

    .composer {
      padding: 16px 24px;
      background: rgba(22, 27, 34, 0.8);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
    }

    .composer-inner {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      position: relative;
    }

    .composer textarea {
      flex: 1;
      min-height: var(--control-height);
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 15px;
      resize: none;
      outline: none;
      transition: var(--transition);
    }

    .composer textarea:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(106, 166, 255, 0.2);
    }

    .composer-actions {
      display: flex;
      gap: 12px;
    }

    .composer-btn {
      width: var(--control-height);
      height: var(--control-height);
      border: none;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      flex-shrink: 0;
    }

    .send-btn {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(106, 166, 255, 0.25);
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .build-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    .build-btn:hover {
      background: rgba(58, 210, 159, 0.1);
      border-color: var(--success);
      color: var(--success);
    }

    /* Builder Panel */
    .builder-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: var(--transition);
    }

    .builder-panel.active {
      transform: translateY(0);
    }

    .builder-header {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .builder-title {
      font-weight: 600;
      font-size: 18px;
    }

    .close-builder {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    .builder-main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .file-explorer {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .file-explorer-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .file-actions {
      display: flex;
      gap: 8px;
    }

    .file-action-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .file-action-btn:hover {
      background: rgba(106, 166, 255, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .file-item {
      padding: 10px 12px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      background: var(--bg-tertiary);
      border: 1px solid transparent;
    }

    .file-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .file-item.active {
      background: rgba(106, 166, 255, 0.15);
      border-color: var(--accent-primary);
    }

    .editor-preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .editor-tabs {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .editor-tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }

    .editor-tab.active {
      border-bottom: 2px solid var(--accent-primary);
      color: var(--accent-primary);
    }

    .editor-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .editor-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-tertiary);
    }

    .code-editor {
      flex: 1;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 16px;
      border: none;
      outline: none;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      resize: none;
    }

    .editor-actions {
      padding: 12px 16px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
    }

    .editor-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .editor-btn:hover {
      background: rgba(106, 166, 255, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .editor-btn.primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
    }

    .editor-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(106, 166, 255, 0.25);
    }

    .preview-pane {
      flex: 1;
      display: none;
      background: white;
      position: relative;
    }

    .preview-pane.active {
      display: block;
    }

    .preview-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
        z-index: 200;
      }

      .sidebar.active {
        transform: translateX(0);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .close-sidebar {
        display: block;
      }

      .toggle-sidebar {
        display: flex;
      }

      .composer-inner {
        gap: 8px;
      }

      .topbar-actions {
        display: none;
      }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 2000;
    }

    .toast {
      padding: 16px 20px;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }

    .toast.success {
      border-left: 3px solid var(--success);
    }

    .toast.error {
      border-left: 3px solid var(--error);
    }

    .toast.warning {
      border-left: 3px solid var(--warning);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Loading indicator */
    .loader {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(106, 166, 255, 0.2);
      border-radius: 50%;
      border-top: 3px solid var(--accent-primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-robot"></i>
        </div>
        <span>Buddy AI</span>
      </div>
      <button class="close-sidebar" aria-label="Close sidebar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="sidebar-content">
      <div class="sidebar-section">
        <button class="btn btn-primary" id="new-chat-btn">
          <i class="fas fa-plus"></i>
          New Chat
        </button>
      </div>
      
      <div class="sidebar-section">
        <div class="section-title">Recent Chats</div>
        <div class="conversation-list" id="conversation-list">
          <!-- Conversations will be dynamically added here -->
        </div>
      </div>
      
      <div class="sidebar-section">
        <div class="section-title">AI Models</div>
        <div class="model-list">
          <div class="conversation-item">
            <div class="conversation-icon">
              <i class="fas fa-brain"></i>
            </div>
            <div class="conversation-name">GPT-4 Turbo</div>
          </div>
          
          <div class="conversation-item">
            <div class="conversation-icon">
              <i class="fas fa-brain"></i>
            </div>
            <div class="conversation-name">Claude 3.5 Sonnet</div>
          </div>
          
          <div class="conversation-item">
            <div class="conversation-icon">
              <i class="fas fa-brain"></i>
            </div>
            <div class="conversation-name">Llama 3.1 70B</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="sidebar-section" style="padding: 16px; border-top: 1px solid var(--border);">
      <div class="btn">
        <i class="fas fa-cog"></i>
        Settings
      </div>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <div class="topbar">
      <button class="toggle-sidebar" aria-label="Toggle sidebar">
        <i class="fas fa-bars"></i>
      </button>
      <div class="current-conversation" id="current-conversation">Welcome to Buddy AI</div>
      <div class="topbar-actions">
        <button class="topbar-btn" aria-label="Export conversation">
          <i class="fas fa-download"></i>
        </button>
        <button class="topbar-btn" aria-label="Clear chat">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
    
    <div class="chat-container" id="chat-container">
      <div class="empty-state" id="empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-comments"></i>
        </div>
        <h3>Start a conversation with Buddy AI</h3>
        <p>Ask anything or request help with coding, design, or content creation</p>
        <div style="margin-top: 24px; display: flex; flex-wrap: wrap; gap: 12px; max-width: 500px;">
          <div class="btn" onclick="quickPrompt('Create a responsive website layout')">
            <i class="fas fa-laptop-code"></i> Website Design
          </div>
          <div class="btn" onclick="quickPrompt('Write a Python script for data analysis')">
            <i class="fas fa-code"></i> Coding Help
          </div>
          <div class="btn" onclick="quickPrompt('Generate marketing content for a SaaS product')">
            <i class="fas fa-file-alt"></i> Content Creation
          </div>
        </div>
      </div>
    </div>
    
    <div class="composer">
      <div class="composer-inner">
        <textarea 
          id="message-input" 
          placeholder="Ask Buddy anything..." 
          aria-label="Type your message"
          rows="1"
        ></textarea>
        <div class="composer-actions">
          <button class="composer-btn build-btn" id="build-btn" title="Build from prompt" aria-label="Build from prompt">
            <i class="fas fa-hammer"></i>
          </button>
          <button class="composer-btn send-btn" id="send-btn" aria-label="Send message">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Builder Panel -->
    <div class="builder-panel" id="builder-panel">
      <div class="builder-header">
        <div class="builder-title">Project Builder</div>
        <button class="close-builder" id="close-builder" aria-label="Close builder">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="builder-main">
        <div class="file-explorer">
          <div class="file-explorer-header">
            <h3>Project Files</h3>
            <div class="file-actions">
              <button class="file-action-btn" id="new-file-btn" aria-label="New file">
                <i class="fas fa-file"></i>
              </button>
              <button class="file-action-btn" id="new-folder-btn" aria-label="New folder">
                <i class="fas fa-folder"></i>
              </button>
            </div>
          </div>
          
          <div class="file-list" id="file-list">
            <!-- Files will be dynamically added here -->
          </div>
        </div>
        
        <div class="editor-preview-container">
          <div class="editor-tabs">
            <div class="editor-tab active" data-tab="editor">Editor</div>
            <div class="editor-tab" data-tab="preview">Preview</div>
          </div>
          
          <div class="editor-content">
            <div class="editor-pane">
              <textarea class="code-editor" id="code-editor" spellcheck="false"></textarea>
              
              <div class="editor-actions">
                <button class="editor-btn" id="save-file-btn">
                  <i class="fas fa-save"></i> Save
                </button>
                <button class="editor-btn primary" id="run-project-btn">
                  <i class="fas fa-play"></i> Run Project
                </button>
              </div>
            </div>
            
            <div class="preview-pane">
              <iframe class="preview-frame" id="preview-frame"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    // State management
    const state = {
      conversations: [],
      currentConversationId: null,
      messages: [],
      isSidebarOpen: true,
      isBuilderOpen: false,
      projectFiles: [],
      selectedFileId: null,
      projectRoot: null,
      aiModels: [
        { id: 'gpt4', name: 'GPT-4 Turbo', isActive: true },
        { id: 'claude', name: 'Claude 3.5 Sonnet', isActive: true },
        { id: 'llama', name: 'Llama 3.1 70B', isActive: false }
      ]
    };

    // DOM Elements
    const dom = {
      sidebar: document.querySelector('.sidebar'),
      toggleSidebar: document.querySelector('.toggle-sidebar'),
      closeSidebar: document.querySelector('.close-sidebar'),
      chatContainer: document.getElementById('chat-container'),
      emptyState: document.getElementById('empty-state'),
      messageInput: document.getElementById('message-input'),
      sendBtn: document.getElementById('send-btn'),
      buildBtn: document.getElementById('build-btn'),
      builderPanel: document.getElementById('builder-panel'),
      closeBuilder: document.getElementById('close-builder'),
      conversationList: document.getElementById('conversation-list'),
      currentConversation: document.getElementById('current-conversation'),
      toastContainer: document.getElementById('toast-container'),
      fileList: document.getElementById('file-list'),
      codeEditor: document.getElementById('code-editor'),
      newFileBtn: document.getElementById('new-file-btn'),
      newFolderBtn: document.getElementById('new-folder-btn'),
      saveFileBtn: document.getElementById('save-file-btn'),
      runProjectBtn: document.getElementById('run-project-btn'),
      editorTabs: document.querySelectorAll('.editor-tab'),
      previewFrame: document.getElementById('preview-frame')
    };

    // Initialize the application
    async function init() {
      setupEventListeners();
      loadState();
      renderConversations();
      await handleAuth();
      if (state.currentConversationId) {
        state.projectRoot = 'BuddyAI_' + state.currentConversationId;
        await ensureProjectRoot();
        await loadProjectFiles();
        renderFiles();
      }
      updateUI();
    }

    // Handle Puter authentication
    async function handleAuth() {
      try {
        if (!await puter.auth.isSignedIn()) {
          showToast('Please sign in to Puter to use cloud features', 'warning');
          await puter.auth.signIn();
          showToast('Signed in successfully', 'success');
        }
      } catch (error) {
        showToast('Authentication failed: ' + error.message, 'error');
      }
    }

    // Ensure project root exists
    async function ensureProjectRoot() {
      try {
        const stat = await puter.fs.stat(state.projectRoot);
        if (!stat) {
          await puter.fs.mkdir(state.projectRoot);
        }
      } catch (error) {
        if (error.code === 'does_not_exist') {
          await puter.fs.mkdir(state.projectRoot);
        } else {
          throw error;
        }
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      // Sidebar toggle
      dom.toggleSidebar.addEventListener('click', toggleSidebar);
      dom.closeSidebar.addEventListener('click', toggleSidebar);
      
      // Send message
      dom.sendBtn.addEventListener('click', sendMessage);
      dom.messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Auto-resize textarea
      dom.messageInput.addEventListener('input', () => {
        dom.messageInput.style.height = 'auto';
        dom.messageInput.style.height = dom.messageInput.scrollHeight + 'px';
      });
      
      // Builder panel
      dom.buildBtn.addEventListener('click', startBuild);
      dom.closeBuilder.addEventListener('click', toggleBuilder);
      
      // Editor tabs
      dom.editorTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });
      
      // File actions
      dom.newFileBtn.addEventListener('click', createNewFile);
      dom.newFolderBtn.addEventListener('click', createNewFolder);
      dom.saveFileBtn.addEventListener('click', saveCurrentFile);
      dom.runProjectBtn.addEventListener('click', runProject);
      
      // New chat button
      document.getElementById('new-chat-btn').addEventListener('click', createNewConversation);
    }

    // Toggle sidebar visibility
    function toggleSidebar() {
      state.isSidebarOpen = !state.isSidebarOpen;
      dom.sidebar.classList.toggle('active', state.isSidebarOpen);
      saveState();
    }

    // Toggle builder panel
    async function toggleBuilder() {
      state.isBuilderOpen = !state.isBuilderOpen;
      dom.builderPanel.classList.toggle('active', state.isBuilderOpen);
      if (state.isBuilderOpen) {
        await loadProjectFiles();
        renderFiles();
      }
      saveState();
    }

    // Switch editor/preview tab
    function switchTab(tabName) {
      dom.editorTabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      
      if (tabName === 'editor') {
        document.querySelector('.editor-pane').style.display = 'flex';
        document.querySelector('.preview-pane').classList.remove('active');
      } else {
        document.querySelector('.editor-pane').style.display = 'none';
        document.querySelector('.preview-pane').classList.add('active');
      }
    }

    // Create new conversation
    async function createNewConversation() {
      const newConversation = {
        id: Date.now().toString(),
        name: 'New Conversation',
        createdAt: new Date(),
        messages: []
      };
      
      state.conversations.unshift(newConversation);
      state.currentConversationId = newConversation.id;
      state.messages = [];
      state.projectRoot = 'BuddyAI_' + state.currentConversationId;
      await ensureProjectRoot();
      await loadProjectFiles();
      
      renderConversations();
      renderMessages();
      saveState();
      updateUI();
      
      showToast('New conversation created', 'success');
    }

    // Send message to AI
    async function sendMessage() {
      const message = dom.messageInput.value.trim();
      if (!message) return;
      
      addMessage({
        id: Date.now().toString(),
        role: 'user',
        content: message,
        timestamp: new Date()
      });
      
      dom.messageInput.value = '';
      dom.messageInput.style.height = 'auto';
      
      const loadingId = Date.now().toString();
      addMessage({
        id: loadingId,
        role: 'assistant',
        content: '',
        timestamp: new Date(),
        isLoading: true
      });
      
      try {
        const response = await puter.ai.chat(message, { model: 'gpt-4o' });
        removeMessage(loadingId);
        addMessage({
          id: Date.now().toString(),
          role: 'assistant',
          content: response,
          timestamp: new Date()
        });
      } catch (error) {
        removeMessage(loadingId);
        showToast('Error getting AI response: ' + error.message, 'error');
      }
    }

    // Start build process
    async function startBuild() {
      const prompt = dom.messageInput.value.trim();
      if (!prompt) return;
      
      addMessage({
        id: Date.now().toString(),
        role: 'user',
        content: `Build project: ${prompt}`,
        timestamp: new Date()
      });
      
      dom.messageInput.value = '';
      dom.messageInput.style.height = 'auto';
      
      const loadingId = Date.now().toString();
      addMessage({
        id: loadingId,
        role: 'assistant',
        content: '',
        timestamp: new Date(),
        isLoading: true
      });
      
      try {
        await handleAuth();
        await ensureProjectRoot();
        
        // Decider AI
        addGuideMessage('Analyzing your request...');
        const deciderModel = 'grok-beta';
        const deciderPrompt = `Analyze the user's build request: "${prompt}". Determine what the user wants to build, key features, technologies to use. Also, list 3-5 search queries to gather more data if needed.
Output only valid JSON: {
  "summary": "brief summary",
  "features": ["list"],
  "technologies": ["list"],
  "search_queries": ["query1", "query2"]
}`;
        const deciderResponse = await puter.ai.chat(deciderPrompt, { model: deciderModel });
        const deciderJson = JSON.parse(deciderResponse);
        addGuideMessage('Analysis complete: ' + deciderJson.summary);

        // Researcher AI
        addGuideMessage('Researching additional data...');
        const researchModel = 'gemini-1.5-flash';
        let researchData = '';
        for (const query of deciderJson.search_queries) {
          const res = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`);
          const json = await res.json();
          researchData += `\nQuery: ${query}\nAbstract: ${json.Abstract || ''}\nHeading: ${json.Heading || ''}\nRelated: ${json.RelatedTopics ? json.RelatedTopics.map(t => t.Text).join('\n') : ''}\n`;
        }
        const researchPrompt = `Summarize this research data for building the project: ${deciderJson.summary}. Data: ${researchData}`;
        const researchSummary = await puter.ai.chat(researchPrompt, { model: researchModel });
        addGuideMessage('Research summary: ' + researchSummary.slice(0, 200) + '...');

        // Architect AI
        addGuideMessage('Designing project architecture...');
        const architectModel = 'claude-3-5-sonnet';
        const architectPrompt = `Design the file structure for the project: ${deciderJson.summary}. Features: ${deciderJson.features.join(', ')}. Technologies: ${deciderJson.technologies.join(', ')}. Research: ${researchSummary}.
Output only valid JSON: {
  "folders": ["path/to/folder", ...],
  "files": [
    {"path": "file.js", "description": "desc", "libraries": ["lib1"]}
  ]
}`;
        const architectResponse = await puter.ai.chat(architectPrompt, { model: architectModel });
        const architectJson = JSON.parse(architectResponse);

        // Create structure
        addGuideMessage('Creating folders and files...');
        for (const folder of architectJson.folders) {
          await puter.fs.mkdir(`${state.projectRoot}/${folder}`);
        }
        for (const file of architectJson.files) {
          await puter.fs.write(`${state.projectRoot}/${file.path}`, '');
        }
        await loadProjectFiles();
        renderFiles();
        addGuideMessage('Architecture created.');

        // Coder AI
        addGuideMessage('Generating code...');
        const coderModel = 'meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo';
        for (const file of architectJson.files) {
          addGuideMessage(`Generating code for ${file.path}...`);
          const codePrompt = `Write the complete code for ${file.path} in the project ${deciderJson.summary}. Description: ${file.description}. Use libraries: ${file.libraries.join(', ')}. Make sure it fits with other files.
Research: ${researchSummary}
Output only the code, no explanations.`;
          const resp = await puter.ai.chat(codePrompt, { model: coderModel, stream: true });
          let code = '';
          const messageId = Date.now().toString();
          addMessage({
            id: messageId,
            role: 'assistant',
            content: `Code for ${file.path}:\n\`\`\`\n`,
            timestamp: new Date()
          });
          for await (const part of resp) {
            const text = part?.text || '';
            code += text;
            updateMessageContent(messageId, `Code for ${file.path}:\n\`\`\`\n${code}\n\`\`\``);
          }
          await puter.fs.write(`${state.projectRoot}/${file.path}`, code);
          if (state.selectedFileId === `${state.projectRoot}/${file.path}`) {
            dom.codeEditor.value = code;
          }
        }
        addGuideMessage('Code generation complete.');

        // Preview
        addGuideMessage('Preparing preview...');
        const hasIndex = architectJson.files.some(f => f.path.toLowerCase() === 'index.html');
        if (hasIndex) {
          const subdomain = puter.randName();
          const site = await puter.hosting.create(subdomain, state.projectRoot);
          dom.previewFrame.src = `https://${site.subdomain}.puter.site`;
          switchTab('preview');
          addGuideMessage(`Project hosted at https://${site.subdomain}.puter.site`);
        } else {
          addGuideMessage('No index.html found for preview.');
        }

        removeMessage(loadingId);
      } catch (error) {
        removeMessage(loadingId);
        showToast('Build process failed: ' + error.message, 'error');
      }
    }

    // Add guide message
    function addGuideMessage(text) {
      addMessage({
        id: Date.now().toString(),
        role: 'assistant',
        content: text,
        timestamp: new Date()
      });
    }

    // Update message content
    function updateMessageContent(id, content) {
      const messageEl = dom.chatContainer.querySelector(`[data-id="${id}"]`);
      if (messageEl) {
        const body = messageEl.querySelector('.message-body');
        body.innerHTML = formatMessageContent(content);
      }
    }

    // Remove message
    function removeMessage(id) {
      state.messages = state.messages.filter(msg => msg.id !== id);
      renderMessages();
    }

    // Add message to the current conversation
    function addMessage(message) {
      state.messages.push(message);
      
      const conversation = state.conversations.find(c => c.id === state.currentConversationId);
      if (conversation) {
        conversation.messages = state.messages;
        conversation.updatedAt = new Date();
      }
      
      renderMessages();
      saveState();
      scrollToBottom();
    }

    // Load project files recursively
    async function loadProjectFiles(path = state.projectRoot, parent = null) {
      try {
        const entries = await puter.fs.readdir(path);
        const items = [];
        for (const entry of entries) {
          const fullPath = `${path}/${entry}`;
          const stat = await puter.fs.stat(fullPath);
          if (stat.is_dir) {
            const item = { id: fullPath, name: entry, type: 'folder', children: [] };
            item.children = await loadProjectFiles(fullPath);
            items.push(item);
          } else {
            items.push({ id: fullPath, name: entry, type: 'file' });
          }
        }
        if (parent === null) {
          state.projectFiles = items;
        }
        return items;
      } catch (error) {
        showToast('Error loading files: ' + error.message, 'error');
        return [];
      }
    }

    // Create new file
    async function createNewFile() {
      const name = prompt('Enter file name:');
      if (!name) return;
      const selected = findItemById(state.projectFiles, state.selectedFileId);
      const basePath = selected && selected.type === 'folder' ? selected.id : state.projectRoot;
      const fullPath = `${basePath}/${name}`;
      await puter.fs.write(fullPath, '');
      await loadProjectFiles();
      renderFiles();
      showToast(`Created file: ${name}`, 'success');
    }

    // Create new folder
    async function createNewFolder() {
      const name = prompt('Enter folder name:');
      if (!name) return;
      const selected = findItemById(state.projectFiles, state.selectedFileId);
      const basePath = selected && selected.type === 'folder' ? selected.id : state.projectRoot;
      const fullPath = `${basePath}/${name}`;
      await puter.fs.mkdir(fullPath);
      await loadProjectFiles();
      renderFiles();
      showToast(`Created folder: ${name}`, 'success');
    }

    // Save current file
    async function saveCurrentFile() {
      if (state.selectedFileId) {
        await puter.fs.write(state.selectedFileId, dom.codeEditor.value);
        showToast('File saved successfully', 'success');
      }
    }

    // Run project in preview
    async function runProject() {
      try {
        const subdomain = puter.randName();
        const site = await puter.hosting.create(subdomain, state.projectRoot);
        dom.previewFrame.src = `https://${site.subdomain}.puter.site`;
        switchTab('preview');
        showToast('Project running in preview', 'success');
      } catch (error) {
        showToast('Error running project: ' + error.message, 'error');
      }
    }

    // Find item by id in tree
    function findItemById(items, id) {
      for (const item of items) {
        if (item.id === id) return item;
        if (item.children) {
          const found = findItemById(item.children, id);
          if (found) return found;
        }
      }
      return null;
    }

    // Render conversation list
    function renderConversations() {
      dom.conversationList.innerHTML = '';
      
      state.conversations.forEach(conversation => {
        const isActive = conversation.id === state.currentConversationId;
        
        const item = document.createElement('div');
        item.className = `conversation-item ${isActive ? 'active' : ''}`;
        item.innerHTML = `
          <div class="conversation-icon">
            <i class="fas fa-comment"></i>
          </div>
          <div class="conversation-name">${conversation.name}</div>
          <div class="conversation-actions">
            <button class="action-btn" data-action="edit" data-id="${conversation.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn" data-action="delete" data-id="${conversation.id}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        item.addEventListener('click', async () => {
          state.currentConversationId = conversation.id;
          state.messages = conversation.messages || [];
          state.projectRoot = 'BuddyAI_' + state.currentConversationId;
          await ensureProjectRoot();
          await loadProjectFiles();
          renderConversations();
          renderMessages();
          if (state.isBuilderOpen) renderFiles();
          saveState();
          updateUI();
        });
        
        dom.conversationList.appendChild(item);
      });
      
      document.querySelectorAll('[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const conversation = state.conversations.find(c => c.id === id);
          if (conversation) {
            const newName = prompt('Enter new name:', conversation.name);
            if (newName) {
              conversation.name = newName;
              renderConversations();
              saveState();
              updateUI();
            }
          }
        });
      });
      
      document.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (confirm('Are you sure you want to delete this conversation?')) {
            state.conversations = state.conversations.filter(c => c.id !== id);
            if (state.currentConversationId === id) {
              state.currentConversationId = null;
              state.messages = [];
              state.projectRoot = null;
            }
            renderConversations();
            renderMessages();
            saveState();
            updateUI();
          }
        });
      });
    }

    // Render messages in chat
    function renderMessages() {
      dom.chatContainer.innerHTML = '';
      
      if (state.messages.length === 0) {
        dom.emptyState.style.display = 'flex';
        return;
      }
      
      dom.emptyState.style.display = 'none';
      
      state.messages.forEach(message => {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.role}`;
        messageEl.dataset.id = message.id;
        
        const timeString = message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageEl.innerHTML = `
          <div class="avatar">
            <i class="fas ${message.role === 'user' ? 'fa-user' : 'fa-robot'}"></i>
          </div>
          <div class="message-content">
            <div class="message-header">
              ${message.role === 'user' ? 'You' : 'Buddy AI'}
              <span class="message-time">${timeString}</span>
            </div>
            <div class="message-body">
              ${formatMessageContent(message.content)}
            </div>
          </div>
          <div class="message-actions">
            <button class="action-btn" title="Copy">
              <i class="fas fa-copy"></i>
            </button>
            <button class="action-btn" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        `;
        
        if (message.isLoading) {
          messageEl.querySelector('.message-body').innerHTML = '<div class="loader"></div>';
        }
        
        dom.chatContainer.appendChild(messageEl);
      });
      
      scrollToBottom();
    }

    // Format message content with syntax highlighting
    function formatMessageContent(content) {
      let formatted = content.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
      formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
      formatted = formatted.replace(/\n/g, '<br>');
      return formatted;
    }

    // Render project files as tree
    function renderFiles() {
      dom.fileList.innerHTML = '';
      renderFileTree(state.projectFiles, dom.fileList, 0);
    }

    function renderFileTree(items, container, level) {
      items.forEach(item => {
        const fileEl = document.createElement('div');
        fileEl.className = `file-item ${item.id === state.selectedFileId ? 'active' : ''}`;
        fileEl.style.paddingLeft = `${level * 20}px`;
        fileEl.innerHTML = `
          <i class="fas ${item.type === 'folder' ? 'fa-folder' : 'fa-file-code'}"></i>
          <span>${item.name}</span>
        `;
        
        fileEl.addEventListener('click', async () => {
          state.selectedFileId = item.id;
          renderFiles();
          if (item.type === 'file') {
            try {
              const blob = await puter.fs.read(item.id);
              const content = await blob.text();
              dom.codeEditor.value = content;
            } catch (error) {
              showToast('Error reading file: ' + error.message, 'error');
            }
          }
        });
        
        container.appendChild(fileEl);
        
        if (item.type === 'folder' && item.children) {
          renderFileTree(item.children, container, level + 1);
        }
      });
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${
          type === 'success' ? 'fa-check-circle' : 
          type === 'error' ? 'fa-exclamation-circle' : 
          'fa-info-circle'
        }"></i>
        <div>${message}</div>
      `;
      
      dom.toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Update UI based on state
    function updateUI() {
      if (state.currentConversationId) {
        const conversation = state.conversations.find(c => c.id === state.currentConversationId);
        if (conversation) {
          dom.currentConversation.textContent = conversation.name;
        }
      } else {
        dom.currentConversation.textContent = 'Welcome to Buddy AI';
      }
      
      dom.emptyState.style.display = state.messages.length === 0 ? 'flex' : 'none';
    }

    // Scroll to bottom of chat
    function scrollToBottom() {
      dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
    }

    // Quick prompt buttons
    function quickPrompt(prompt) {
      dom.messageInput.value = prompt;
      dom.messageInput.dispatchEvent(new Event('input'));
      dom.messageInput.focus();
    }

    // Save state to localStorage
    function saveState() {
      localStorage.setItem('buddy-ai-state', JSON.stringify(state));
    }

    // Load state from localStorage
    function loadState() {
      const savedState = localStorage.getItem('buddy-ai-state');
      if (savedState) {
        try {
          const parsed = JSON.parse(savedState);
          Object.assign(state, parsed);
        } catch (e) {
          console.error('Failed to parse saved state', e);
        }
      }
      
      if (state.conversations.length === 0) {
        state.conversations.push({
          id: 'default',
          name: 'Welcome Conversation',
          createdAt: new Date(),
          messages: [
            {
              id: 'welcome',
              role: 'assistant',
              content: 'Hello! I\'m Buddy, your AI assistant. How can I help you today?',
              timestamp: new Date()
            }
          ]
        });
        state.currentConversationId = 'default';
        state.messages = state.conversations[0].messages;
        state.projectRoot = 'BuddyAI_default';
      }
    }

    // Initialize the app
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
