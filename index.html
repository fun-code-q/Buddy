<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buddy AI - Your AI Coding Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Add Puter.js script -->
    <script src="https://js.puter.com/v2/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --dark: #1e293b;
            --darker: #0f172a;
            --light: #f8fafc;
            --gray: #94a3b8;
            --dark-gray: #334155;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--darker);
            color: var(--light);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .mono {
            font-family: 'Fira Code', monospace;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Code editor styling */
        .code-editor {
            background-color: #0f172a;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .editor-header {
            background-color: #1e293b;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .editor-content {
            font-family: 'Fira Code', monospace;
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
            outline: none;
            white-space: pre-wrap;
            tab-size: 2;
        }
        
        /* Thinking animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .thinking-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray);
            margin: 0 2px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        .thinking-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .thinking-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Transition effects */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        /* File tree styling */
        .file-tree {
            padding-left: 1rem;
        }
        
        .file-item {
            padding: 0.25rem 0;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .file-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .file-icon {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        /* Panel resizing */
        .resizable {
            resize: horizontal;
            overflow: auto;
        }
        
        @media (max-width: 768px) {
            .resizable {
                resize: none;
            }
        }
        
        /* Mobile drawer animations */
        @keyframes slideInFromTop {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        @keyframes slideInFromBottom {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        .mobile-drawer-top {
            animation: slideInFromTop 0.3s ease-out;
        }
        
        .mobile-drawer-bottom {
            animation: slideInFromBottom 0.3s ease-out;
        }
        
        /* Syntax highlighting */
        .token.comment { color: #6a9955; }
        .token.keyword { color: #569cd6; }
        .token.string { color: #ce9178; }
        .token.function { color: #dcdcaa; }
        .token.tag { color: #569cd6; }
        .token.attribute { color: #9cdcfe; }
        .token.property { color: #9cdcfe; }
        .token.selector { color: #d7ba7d; }
        
        /* Loading animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }
        
        /* NEW STYLES FOR THE UPDATED FEATURES */
        
        /* Chat input fixed to bottom */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #334155;
            background-color: #0f172a;
            position: sticky;
            bottom: 0;
        }
        
        /* Chat bubble action buttons */
        .chat-bubble-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chat-bubble:hover .chat-bubble-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0.25rem;
        }
        
        .action-btn:hover {
            color: #e2e8f0;
        }
        
        /* Thinking timer */
        .thinking-timer {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.5rem;
        }
        
        /* Scrollable sections */
        .scrollable-section {
            overflow-y: auto;
        }
        
        /* File edit icon */
        .file-edit-icon {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s ease;
            padding: 0.25rem;
            cursor: pointer;
        }
        
        .file-item:hover .file-edit-icon {
            opacity: 1;
        }
        
        /* FIXED STYLES */
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #builder-page {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .builder-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            margin-top: 64px; /* Height of header */
            height: calc(100vh - 64px);
        }
        
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0; /* Allows flex item to shrink properly */
        }
        
        #code-editor-container, #preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .preview-content {
            flex: 1;
            display: flex;
            overflow: auto;
        }
        
        #website-preview {
            flex: 1;
            border: none;
        }
        
        #editor-toolbar {
            flex-shrink: 0;
        }
        
        .panel-section {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .panel-content {
            flex: 1;
            overflow: auto;
        }
        
        header {
            z-index: 100;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- App Container -->
    <div id="app" class="flex flex-col flex-1">
        <!-- Page 1: Welcome Screen -->
        <div id="welcome-page" class="flex flex-col items-center justify-center flex-1 p-4 transition-all duration-300">
            <header class="w-full fixed top-0 left-0 p-4 flex justify-between items-center bg-slate-900/80 backdrop-blur-sm z-50">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold">Buddy AI</h1>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-700 transition-colors">
                    <i class="fas fa-moon text-yellow-300"></i>
                </button>
            </header>
            
            <main class="w-full max-w-2xl mx-auto mt-16 mb-8 px-4 flex flex-col items-center">
                <h2 class="text-4xl font-bold text-center mb-6 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">Build Websites with AI</h2>
                <p class="text-slate-300 text-center mb-8">Describe your website idea and Buddy AI will generate the code in real-time.</p>
                
                <div class="w-full relative mb-6">
                    <textarea id="prompt-input" class="w-full p-4 rounded-lg bg-slate-800 border border-slate-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 outline-none transition-all h-32 resize-none" placeholder="Describe the website you want to build..."></textarea>
                    <button id="send-prompt" class="absolute right-3 bottom-3 p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <div class="w-full flex flex-wrap justify-center gap-2 mb-8">
                    <button class="prompt-suggestion px-4 py-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors text-sm">Create a portfolio page</button>
                    <button class="prompt-suggestion px-4 py-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors text-sm">Build a weather app</button>
                    <button class="prompt-suggestion px-4 py-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors text-sm">Make a todo list with React</button>
                    <button class="prompt-suggestion px-4 py-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors text-sm">Design a landing page</button>
                </div>
                
                <div class="flex items-center space-x-4 text-slate-400 text-sm">
                    <span class="flex items-center"><i class="fas fa-bolt mr-1 text-emerald-400"></i> Instant generation</span>
                    <span class="flex items-center"><i class="fas fa-code mr-1 text-blue-400"></i> Real-time preview</span>
                    <span class="flex items-center"><i class="fas fa-cloud-download-alt mr-1 text-purple-400"></i> Export anytime</span>
                </div>
            </main>
        </div>
        
        <!-- Page 2: Builder Workspace (Hidden Initially) -->
        <div id="builder-page" class="hidden flex-1 flex-col">
            <!-- Header -->
            <header class="w-full fixed top-0 left-0 p-2 sm:p-4 flex justify-between items-center bg-slate-900/80 backdrop-blur-sm z-50 border-b border-slate-800">
                <div class="flex items-center space-x-2">
                    <button id="menu-toggle" class="p-2 rounded-lg hover:bg-slate-700 transition-colors md:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="hidden md:flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <h1 class="text-xl font-bold">Buddy AI</h1>
                    </div>
                    
                    <div id="menu-dropdown" class="hidden absolute top-16 left-4 bg-slate-800 rounded-lg shadow-xl p-2 w-64 z-50 border border-slate-700">
                        <div class="text-sm text-slate-300 px-2 py-1">Current Project: <span id="current-project-name-menu">My Project</span></div>
                        <button id="new-project-btn" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i> Create New Project
                        </button>
                        <button id="delete-project-btn" class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 transition-colors text-red-400">
                            <i class="fas fa-trash mr-2"></i> Delete Project
                        </button>
                    </div>
                </div>
                
                <!-- Removed the "My project" editable name section from header -->
                
                <div class="flex items-center space-x-2">
                    <button id="toggle-code" class="p-2 rounded-lg hover:bg-slate-700 transition-colors text-blue-400">
                        <i class="fas fa-code"></i>
                    </button>
                    <button id="toggle-preview" class="p-2 rounded-lg hover:bg-slate-700 transition-colors text-emerald-400">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button id="export-pdf" class="p-2 rounded-lg hover:bg-slate-700 transition-colors text-purple-400 hidden sm:block">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button id="theme-toggle-builder" class="p-2 rounded-lg hover:bg-slate-700 transition-colors hidden sm:block">
                        <i class="fas fa-moon text-yellow-300"></i>
                    </button>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <div class="builder-content">
                <!-- Column 1: AI Chat Panel -->
                <div id="chat-panel" class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:block resizable" style="min-width: 250px; max-width: 400px;">
                    <div class="panel-section">
                        <div class="p-3 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-medium">Chat with Buddy</h3>
                            <button id="minimize-chat" class="p-1 rounded hover:bg-slate-800 transition-colors">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                        <div class="panel-content">
                            <div id="chat-messages" class="chat-messages-container scrollable-section space-y-4">
                                <!-- Chat messages will be added here -->
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <div class="relative">
                                <input id="chat-input" type="text" placeholder="Message Buddy..." class="w-full p-2 pl-3 pr-10 rounded-lg bg-slate-800 border border-slate-700 focus:border-blue-500 outline-none">
                                <button id="send-chat" class="absolute right-2 top-2 text-blue-400">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Column 2: File Manager -->
                <div id="file-panel" class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:block resizable" style="min-width: 200px; max-width: 350px;">
                    <div class="panel-section">
                        <div class="p-3 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-medium">Project Files</h3>
                            <div class="flex space-x-1">
                                <button id="add-file" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Add File">
                                    <i class="fas fa-file text-blue-400"></i>
                                </button>
                                <button id="add-folder" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Add Folder">
                                    <i class="fas fa-folder text-yellow-400"></i>
                                </button>
                                <button id="minimize-files" class="p-1 rounded hover:bg-slate-800 transition-colors">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-2 border-b border-slate-800 flex space-x-2">
                            <button id="save-project" class="flex-1 py-1 px-2 text-sm rounded bg-slate-800 hover:bg-slate-700 transition-colors">
                                <i class="fas fa-save mr-1"></i>
                            </button>
                            <button id="download-project" class="flex-1 py-1 px-2 text-sm rounded bg-blue-600 hover:bg-blue-700 transition-colors">
                                <i class="fas fa-download mr-1"></i>
                            </button>
                        </div>
                        <div class="panel-content">
                            <div id="file-tree" class="p-2 scrollable-section">
                                <div class="file-item folder" data-path="/">
                                    <span class="file-icon"><i class="fas fa-folder text-yellow-400"></i></span>
                                    <span class="file-name">my-project</span>
                                    <span class="file-edit-icon" title="Rename folder">
                                        <i class="fas fa-pencil-alt text-slate-400"></i>
                                    </span>
                                </div>
                                <div class="file-tree ml-4 hidden">
                                    <!-- Files will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Column 3: Main Content (Editor/Preview) -->
                <div id="main-content" class="flex-1 flex flex-col bg-slate-900 overflow-hidden">
                    <!-- Editor Toolbar -->
                    <div id="editor-toolbar" class="p-2 border-b border-slate-800 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <span id="current-file" class="text-sm font-mono px-2 py-1 bg-slate-800 rounded">index.html</span>
                        </div>
                        <div class="flex space-x-2">
                            <button id="copy-code" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Copy Code">
                                <i class="fas fa-copy text-blue-400"></i>
                            </button>
                            <button id="undo" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Undo">
                                <i class="fas fa-undo text-purple-400"></i>
                            </button>
                            <button id="redo" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Redo">
                                <i class="fas fa-redo text-purple-400"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Code Editor -->
                    <div id="code-editor-container" class="flex-1 overflow-hidden">
                        <div class="code-editor h-full">
                            <div class="editor-header">
                                <div class="flex space-x-2">
                                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                </div>
                                <div class="text-xs mono text-slate-400">index.html</div>
                            </div>
                            <pre id="code-editor" class="editor-content mono" contenteditable="true"><!-- Code will be inserted here --></pre>
                        </div>
                    </div>
                    
                    <!-- Preview Container -->
                    <div id="preview-container" class="hidden flex-1 flex-col bg-white overflow-hidden">
                        <div class="p-2 border-b border-slate-200 flex justify-between items-center bg-slate-100">
                            <div class="flex space-x-2">
                                <button class="device-btn active px-2 py-1 text-xs rounded bg-white" data-device="desktop">
                                    <i class="fas fa-desktop mr-1"></i> Desktop
                                </button>
                                <button class="device-btn px-2 py-1 text-xs rounded bg-white" data-device="tablet">
                                    <i class="fas fa-tablet-alt mr-1"></i> Tablet
                                </button>
                                <button class="device-btn px-2 py-1 text-xs rounded bg-white" data-device="mobile">
                                    <i class="fas fa-mobile-alt mr-1"></i> Mobile
                                </button>
                            </div>
                            <button id="refresh-preview" class="p-1 rounded hover:bg-slate-200 transition-colors">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="preview-content">
                            <iframe id="website-preview" class="w-full h-full border border-slate-200 rounded-lg" srcdoc="&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;My Project&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Your website will appear here&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Chat Drawer -->
            <div id="mobile-chat-drawer" class="fixed top-16 left-0 right-0 bg-slate-900 border-b border-slate-800 z-40 shadow-xl hidden md:hidden">
                <div class="p-3 flex justify-between items-center">
                    <h3 class="font-medium">Chat with Buddy</h3>
                    <button id="close-mobile-chat" class="p-1 rounded hover:bg-slate-800 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="mobile-chat-messages" class="h-64 overflow-y-auto p-3 space-y-4 border-t border-slate-800">
                    <!-- Chat messages will be added here -->
                </div>
                <div class="p-3 border-t border-slate-800">
                    <div class="relative">
                        <input id="mobile-chat-input" type="text" placeholder="Message Buddy..." class="w-full p-2 pl-3 pr-10 rounded-lg bg-slate-800 border border-slate-700 focus:border-blue-500 outline-none">
                        <button id="send-mobile-chat" class="absolute right-2 top-2 text-blue-400">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile File Drawer -->
            <div id="mobile-file-drawer" class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800 z-40 shadow-xl hidden md:hidden">
                <div class="p-3 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-medium">Project Files</h3>
                    <div class="flex space-x-1">
                        <button id="mobile-add-file" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Add File">
                            <i class="fas fa-file text-blue-400"></i>
                        </button>
                        <button id="mobile-add-folder" class="p-1 rounded hover:bg-slate-800 transition-colors" title="Add Folder">
                            <i class="fas fa-folder text-yellow-400"></i>
                        </button>
                        <button id="close-mobile-files" class="p-1 rounded hover:bg-slate-800 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="p-2 border-b border-slate-800 flex space-x-2">
                    <button id="mobile-save-project" class="flex-1 py-1 px-2 text-sm rounded bg-slate-800 hover:bg-slate-700 transition-colors">
                        <i class="fas fa-save mr-1"></i> Save
                    </button>
                    <button id="mobile-download-project" class="flex-1 py-1 px-2 text-sm rounded bg-blue-600 hover:bg-blue-700 transition-colors">
                        <i class="fas fa-download mr-1"></i> Download
                    </button>
                </div>
                <div id="mobile-file-tree" class="h-64 overflow-y-auto p-2">
                    <div class="file-item folder" data-path="/">
                        <span class="file-icon"><i class="fas fa-folder text-yellow-400"></i></span>
                        <span class="file-name">my-project</span>
                        <span class="file-edit-icon" title="Rename folder">
                            <i class="fas fa-pencil-alt text-slate-400"></i>
                        </span>
                    </div>
                    <div class="file-tree ml-4 hidden">
                        <!-- Files will be added here dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Mobile Panel Toggles -->
            <div class="fixed bottom-4 right-4 flex flex-col space-y-2 z-50 md:hidden">
                <button id="open-mobile-chat" class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 transition-colors flex items-center justify-center shadow-lg">
                    <i class="fas fa-comment text-white"></i>
                </button>
                <button id="open-mobile-files" class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors flex items-center justify-center shadow-lg">
                    <i class="fas fa-folder-open text-white"></i>
                </button>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full border border-slate-700">
                <h3 class="text-xl font-bold mb-4" id="modal-title">Confirm Action</h3>
                <p class="text-slate-300 mb-6" id="modal-message">Are you sure you want to perform this action?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors">Cancel</button>
                    <button id="modal-confirm" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">Confirm</button>
                </div>
            </div>
        </div>
        
        <!-- New File/Folder Modal -->
        <div id="file-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full border border-slate-700">
                <h3 class="text-xl font-bold mb-4" id="file-modal-title">Create New File</h3>
                <div class="mb-4">
                    <label class="block text-sm text-slate-300 mb-1">Name</label>
                    <input id="file-name-input" type="text" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:border-blue-500 outline-none">
                </div>
                <div class="mb-4" id="file-type-container">
                    <label class="block text-sm text-slate-300 mb-1">Type</label>
                    <select id="file-type-select" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:border-blue-500 outline-none">
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="js">JavaScript</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="file-modal-cancel" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors">Cancel</button>
                    <button id="file-modal-confirm" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors">Create</button>
                </div>
            </div>
        </div>
        
        <!-- Rename Modal -->
        <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full border border-slate-700">
                <h3 class="text-xl font-bold mb-4">Rename</h3>
                <div class="mb-4">
                    <label class="block text-sm text-slate-300 mb-1">New Name</label>
                    <input id="rename-input" type="text" class="w-full p-2 rounded bg-slate-700 border border-slate-600 focus:border-blue-500 outline-none">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="rename-modal-cancel" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors">Cancel</button>
                    <button id="rename-modal-confirm" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors">Rename</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            currentPage: 'welcome',
            theme: 'dark',
            projectName: 'My Project',
            currentFile: 'index.html',
            currentFileContent: '',
            files: {
                '/': {
                    type: 'folder',
                    name: 'my-project',
                    path: '/',
                    children: ['/index.html', '/style.css', '/script.js']
                },
                '/index.html': {
                    type: 'file',
                    name: 'index.html',
                    path: '/index.html',
                    content: '<!DOCTYPE html>\n<html>\n<head>\n    <title>My Project</title>\n    <link rel="stylesheet" href="style.css">\n</head>\n<body>\n    <h1>Welcome to My Project</h1>\n    <p>Your website will be generated here.</p>\n    <script src="script.js"><\/script>\n</body>\n</html>'
                },
                '/style.css': {
                    type: 'file',
                    name: 'style.css',
                    path: '/style.css',
                    content: '/* Add your styles here */\nbody {\n    font-family: Arial, sans-serif;\n    margin: 0;\n    padding: 20px;\n    background-color: #f5f5f5;\n    color: #333;\n}\n\nh1 {\n    color: #2c3e50;\n}'
                },
                '/script.js': {
                    type: 'file',
                    name: 'script.js',
                    path: '/script.js',
                    content: '// Add your JavaScript here\ndocument.addEventListener(\'DOMContentLoaded\', function() {\n    console.log(\'Website loaded successfully!\');\n});'
                }
            },
            chatHistory: [],
            fileHistory: [],
            codeHistory: [],
            undoStack: [],
            redoStack: [],
            thinkingTimers: {} // Track thinking timers for AI responses
        };

        // DOM Elements
        const welcomePage = document.getElementById('welcome-page');
        const builderPage = document.getElementById('builder-page');
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleBuilder = document.getElementById('theme-toggle-builder');
        const promptInput = document.getElementById('prompt-input');
        const sendPrompt = document.getElementById('send-prompt');
        const promptSuggestions = document.querySelectorAll('.prompt-suggestion');
        const menuToggle = document.getElementById('menu-toggle');
        const menuDropdown = document.getElementById('menu-dropdown');
        const projectNameInput = document.getElementById('project-name-input');
        const currentProjectNameMenu = document.getElementById('current-project-name-menu');
        const newProjectBtn = document.getElementById('new-project-btn');
        const deleteProjectBtn = document.getElementById('delete-project-btn');
        const toggleCode = document.getElementById('toggle-code');
        const togglePreview = document.getElementById('toggle-preview');
        const exportPdf = document.getElementById('export-pdf');
        const chatPanel = document.getElementById('chat-panel');
        const minimizeChat = document.getElementById('minimize-chat');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChat = document.getElementById('send-chat');
        const filePanel = document.getElementById('file-panel');
        const minimizeFiles = document.getElementById('minimize-files');
        const addFile = document.getElementById('add-file');
        const addFolder = document.getElementById('add-folder');
        const saveProject = document.getElementById('save-project');
        const downloadProject = document.getElementById('download-project');
        const fileTree = document.getElementById('file-tree');
        const editorToolbar = document.getElementById('editor-toolbar');
        const currentFile = document.getElementById('current-file');
        const copyCode = document.getElementById('copy-code');
        const undo = document.getElementById('undo');
        const redo = document.getElementById('redo');
        const codeEditorContainer = document.getElementById('code-editor-container');
        const codeEditor = document.getElementById('code-editor');
        const previewContainer = document.getElementById('preview-container');
        const deviceBtns = document.querySelectorAll('.device-btn');
        const refreshPreview = document.getElementById('refresh-preview');
        const websitePreview = document.getElementById('website-preview');
        const mobileChatDrawer = document.getElementById('mobile-chat-drawer');
        const closeMobileChat = document.getElementById('close-mobile-chat');
        const mobileChatMessages = document.getElementById('mobile-chat-messages');
        const mobileChatInput = document.getElementById('mobile-chat-input');
        const sendMobileChat = document.getElementById('send-mobile-chat');
        const mobileFileDrawer = document.getElementById('mobile-file-drawer');
        const closeMobileFiles = document.getElementById('close-mobile-files');
        const mobileAddFile = document.getElementById('mobile-add-file');
        const mobileAddFolder = document.getElementById('mobile-add-folder');
        const mobileSaveProject = document.getElementById('mobile-save-project');
        const mobileDownloadProject = document.getElementById('mobile-download-project');
        const mobileFileTree = document.getElementById('mobile-file-tree');
        const openMobileChat = document.getElementById('open-mobile-chat');
        const openMobileFiles = document.getElementById('open-mobile-files');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const fileModal = document.getElementById('file-modal');
        const fileModalTitle = document.getElementById('file-modal-title');
        const fileNameInput = document.getElementById('file-name-input');
        const fileTypeContainer = document.getElementById('file-type-container');
        const fileTypeSelect = document.getElementById('file-type-select');
        const fileModalCancel = document.getElementById('file-modal-cancel');
        const fileModalConfirm = document.getElementById('file-modal-confirm');
        const renameModal = document.getElementById('rename-modal');
        const renameInput = document.getElementById('rename-input');
        const renameModalCancel = document.getElementById('rename-modal-cancel');
        const renameModalConfirm = document.getElementById('rename-modal-confirm');

        // Initialize the application
        function init() {
            // Set up event listeners
            setupEventListeners();
            
            // Load saved state from localStorage if available
            loadState();
            
            // Render initial UI
            renderFileTree();
            updateCodeEditor();
            updatePreview();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Theme toggles
            themeToggle.addEventListener('click', toggleTheme);
            if (themeToggleBuilder) themeToggleBuilder.addEventListener('click', toggleTheme);
            
            // Send prompt
            sendPrompt.addEventListener('click', handleSendPrompt);
            promptInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendPrompt();
                }
            });
            
            // Prompt suggestions
            promptSuggestions.forEach(btn => {
                btn.addEventListener('click', () => {
                    promptInput.value = btn.textContent;
                });
            });
            
            // Menu toggle - Fixed hamburger menu functionality
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                menuDropdown.classList.toggle('hidden');
            });
            
            // Project name input
            projectNameInput.addEventListener('change', (e) => {
                state.projectName = e.target.value;
                currentProjectNameMenu.textContent = e.target.value;
                saveState();
            });
            
            // New project button
            newProjectBtn.addEventListener('click', createNewProject);
            
            // Delete project button
            deleteProjectBtn.addEventListener('click', confirmDeleteProject);
            
            // Toggle code/preview
            toggleCode.addEventListener('click', () => {
                codeEditorContainer.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                toggleCode.classList.add('text-blue-400');
                togglePreview.classList.remove('text-emerald-400');
            });
            
            togglePreview.addEventListener('click', () => {
                codeEditorContainer.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                togglePreview.classList.add('text-emerald-400');
                toggleCode.classList.remove('text-blue-400');
                updatePreview();
            });
            
            // Export PDF
            exportPdf.addEventListener('click', exportChatToPdf);
            
            // Chat panel
            minimizeChat.addEventListener('click', () => {
                chatPanel.classList.toggle('hidden');
            });
            
            sendChat.addEventListener('click', handleSendChat);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendChat();
                }
            });
            
            // File panel
            minimizeFiles.addEventListener('click', () => {
                filePanel.classList.toggle('hidden');
            });
            
            addFile.addEventListener('click', () => showFileModal('file'));
            addFolder.addEventListener('click', () => showFileModal('folder'));
            
            saveProject.addEventListener('click', saveProjectToStorage);
            downloadProject.addEventListener('click', downloadProjectAsZip);
            
            // Code editor
            copyCode.addEventListener('click', copyCodeToClipboard);
            undo.addEventListener('click', undoCodeEdit);
            redo.addEventListener('click', redoCodeEdit);
            
            codeEditor.addEventListener('input', (e) => {
                state.files[`/${state.currentFile}`].content = e.target.textContent;
                updatePreview();
                saveState();
            });
            
            // Preview
            deviceBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deviceBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const device = e.target.dataset.device;
                    setPreviewDevice(device);
                });
            });
            
            refreshPreview.addEventListener('click', updatePreview);
            
            // Mobile drawers
            openMobileChat.addEventListener('click', () => {
                mobileChatDrawer.classList.remove('hidden');
                mobileChatDrawer.classList.add('mobile-drawer-top');
            });
            
            closeMobileChat.addEventListener('click', () => {
                mobileChatDrawer.classList.add('hidden');
            });
            
            sendMobileChat.addEventListener('click', handleSendChat);
            mobileChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendChat();
                }
            });
            
            openMobileFiles.addEventListener('click', () => {
                mobileFileDrawer.classList.remove('hidden');
                mobileFileDrawer.classList.add('mobile-drawer-bottom');
            });
            
            closeMobileFiles.addEventListener('click', () => {
                mobileFileDrawer.classList.add('hidden');
            });
            
            mobileAddFile.addEventListener('click', () => showFileModal('file'));
            mobileAddFolder.addEventListener('click', () => showFileModal('folder'));
            
            mobileSaveProject.addEventListener('click', saveProjectToStorage);
            mobileDownloadProject.addEventListener('click', downloadProjectAsZip);
            
            // Modals
            modalCancel.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
            });
            
            fileModalCancel.addEventListener('click', () => {
                fileModal.classList.add('hidden');
            });
            
            fileModalConfirm.addEventListener('click', handleFileModalConfirm);
            
            renameModalCancel.addEventListener('click', () => {
                renameModal.classList.add('hidden');
            });
            
            renameModalConfirm.addEventListener('click', handleRenameConfirm);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) {
                    menuDropdown.classList.add('hidden');
                }
            });
        }

        // Toggle theme
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.classList.toggle('dark');
            
            // Update UI based on theme
            if (state.theme === 'dark') {
                document.body.style.backgroundColor = '#0f172a';
                document.body.style.color = '#f8fafc';
                if (themeToggle) themeToggle.innerHTML = '<i class="fas fa-moon text-yellow-300"></i>';
                if (themeToggleBuilder) themeToggleBuilder.innerHTML = '<i class="fas fa-moon text-yellow-300"></i>';
            } else {
                document.body.style.backgroundColor = '#f8fafc';
                document.body.style.color = '#0f172a';
                if (themeToggle) themeToggle.innerHTML = '<i class="fas fa-sun text-yellow-500"></i>';
                if (themeToggleBuilder) themeToggleBuilder.innerHTML = '<i class="fas fa-sun text-yellow-500"></i>';
            }
            
            saveState();
        }

        // Handle send prompt
        function handleSendPrompt() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;
            
            // Enhance the prompt with keywords
            const enhancedPrompt = `Create a modern, colorful, UI/UX rich, futuristic ${prompt}`;
            
            // Switch to builder page
            welcomePage.classList.add('hidden');
            builderPage.classList.remove('hidden');
            state.currentPage = 'builder';
            
            // Add user message to chat
            addChatMessage('user', prompt);
            
            // Use Puter AI to generate response
            generateWithPuter(enhancedPrompt);
            
            // Clear input
            promptInput.value = '';
        }

        // Generate with Puter AI
        async function generateWithPuter(prompt) {
            // Show thinking animation
            const thinkingId = addThinkingAnimation();
            
            try {
                // Call Puter AI API with Claude Sonnet 4
                const response = await puter.ai.chat(prompt, { 
                    model: 'claude-sonnet-4', 
                    stream: true 
                });
                
                let fullResponse = '';
                const messageId = addChatMessage('ai', '');
                
                // Remove thinking animation
                removeThinkingAnimation(thinkingId);
                
                // Process streaming response
                for await (const part of response) {
                    if (part.text) {
                        fullResponse += part.text;
                        
                        // Update the message in state
                        const messageIndex = state.chatHistory.findIndex(m => m.id === messageId);
                        if (messageIndex !== -1) {
                            state.chatHistory[messageIndex].content = fullResponse;
                            updateMessageElement(messageId, fullResponse);
                        }
                    }
                }
                
                // Process the AI response to extract and create files
                processAIResponse(fullResponse);
                
            } catch (error) {
                console.error('Error calling Puter AI:', error);
                
                // Remove thinking animation
                removeThinkingAnimation(thinkingId);
                
                // Add error message to chat
                addChatMessage('ai', 'Sorry, I encountered an error while processing your request. Please try again.');
                
                // Show error notification
                showNotification('Error connecting to AI service. Using demo response instead.', 'error');
                
                // Use demo response as fallback
                useDemoResponse(prompt);
            }
        }

        // Update message element without re-rendering entire chat
        function updateMessageElement(messageId, content) {
            // Update desktop chat
            const desktopMessage = document.getElementById(`message-${messageId}`);
            if (desktopMessage) {
                const contentElement = desktopMessage.querySelector('.message-content');
                if (contentElement) {
                    contentElement.innerHTML = formatMessageContent(content);
                }
            }
            
            // Update mobile chat
            const mobileMessage = document.getElementById(`mobile-message-${messageId}`);
            if (mobileMessage) {
                const contentElement = mobileMessage.querySelector('.message-content');
                if (contentElement) {
                    contentElement.innerHTML = formatMessageContent(content);
                }
            }
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            mobileChatMessages.scrollTop = mobileChatMessages.scrollHeight;
        }

        // Use demo response when API fails
        function useDemoResponse(prompt) {
            // Create demo response based on prompt
            let htmlContent = '';
            let cssContent = '';
            let jsContent = '';
            
            if (prompt.toLowerCase().includes('portfolio')) {
                htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio - ${state.projectName}</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">${state.projectName}</div>
            <ul>
                <li><a href="#home">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#projects">Projects</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </nav>
    </header>
    
    <main>
        <section id="home" class="hero">
            <div class="hero-content">
                <h1>Creative Developer & Designer</h1>
                <p>I create amazing digital experiences</p>
                <button class="cta-button">View My Work</button>
            </div>
        </section>
        
        <section id="about">
            <h2>About Me</h2>
            <p>I'm a passionate developer with expertise in modern web technologies.</p>
        </section>
        
        <section id="projects">
            <h2>My Projects</h2>
            <div class="projects-grid">
                <div class="project-card">
                    <h3>Project 1</h3>
                    <p>Description of project 1</p>
                </div>
                <div class="project-card">
                    <h3>Project 2</h3>
                    <p>Description of project 2</p>
                </div>
                <div class="project-card">
                    <h3>Project 3</h3>
                    <p>Description of project 3</p>
                </div>
            </div>
        </section>
        
        <section id="contact">
            <h2>Get In Touch</h2>
            <form>
                <input type="text" placeholder="Your Name">
                <input type="email" placeholder="Your Email">
                <textarea placeholder="Your Message"></textarea>
                <button type="submit">Send Message</button>
            </form>
        </section>
    </main>
    
    <footer>
        <p>&copy; ${new Date().getFullYear()} ${state.projectName}. All rights reserved.</p>
    </footer>
    
    <script src="script.js"><\/script>
</body>
</html>`;

                cssContent = `/* Global Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    color: #333;
}

/* Header & Navigation */
header {
    background: rgba(255, 255, 255, 0.95);
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 5%;
    max-width: 1200px;
    margin: 0 auto;
}

.logo {
    font-size: 1.5rem;
    font-weight: bold;
    color: #3b82f6;
}

nav ul {
    display: flex;
    list-style: none;
    gap: 2rem;
}

nav a {
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: color 0.3s;
}

nav a:hover {
    color: #3b82f6;
}

/* Hero Section */
.hero {
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
}

.hero-content h1 {
    font-size: 3.5rem;
    margin-bottom: 1rem;
}

.hero-content p {
    font-size: 1.5rem;
    margin-bottom: 2rem;
}

.cta-button {
    background: #f8fafc;
    color: #3b82f6;
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 50px;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
}

.cta-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

/* Sections */
section {
    padding: 5rem 5%;
    max-width: 1200px;
    margin: 0 auto;
}

section h2 {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    text-align: center;
}

/* Projects Grid */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.project-card {
    background: #f8fafc;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
}

.project-card:hover {
    transform: translateY(-5px);
}

/* Contact Form */
form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 600px;
    margin: 0 auto;
}

input, textarea {
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: inherit;
}

button[type="submit"] {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1.1rem;
}

/* Footer */
footer {
    background: #1e293b;
    color: white;
    text-align: center;
    padding: 2rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    nav {
        flex-direction: column;
        gap: 1rem;
    }
    
    .hero-content h1 {
        font-size: 2.5rem;
    }
    
    section {
        padding: 3rem 5%;
    }
}`;

                jsContent = `// Portfolio JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scrolling for navigation links
    document.querySelectorAll('nav a').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetSection = document.querySelector(targetId);
            
            window.scrollTo({
                top: targetSection.offsetTop - 80,
                behavior: 'smooth'
            });
        });
    });
    
    // Form submission handling
    const contactForm = document.querySelector('form');
    if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Thank you for your message! This is a demo form.');
            contactForm.reset();
        });
    }
    
    // Animate elements on scroll
    const animateOnScroll = function() {
        const elements = document.querySelectorAll('.project-card, section h2, form');
        
        elements.forEach(element => {
            const elementPosition = element.getBoundingClientRect().top;
            const screenPosition = window.innerHeight / 1.3;
            
            if (elementPosition < screenPosition) {
                element.style.opacity = 1;
                element.style.transform = 'translateY(0)';
            }
        });
    };
    
    // Set initial state for animation
    document.querySelectorAll('.project-card, section h2, form').forEach(element => {
        element.style.opacity = 0;
        element.style.transform = 'translateY(20px)';
        element.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    });
    
    // Listen for scroll events
    window.addEventListener('scroll', animateOnScroll);
    // Trigger once on load
    animateOnScroll();
    
    console.log('Portfolio website loaded successfully!');
});`;
            } else {
                // Default template for other requests
                htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${state.projectName}</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Welcome to ${state.projectName}</h1>
        <p>Created with Buddy AI</p>
    </header>
    
    <main>
        <section class="hero">
            <h2>Modern, Responsive Design</h2>
            <p>This website was generated based on your request: "${prompt}"</p>
            <button class="cta-button">Get Started</button>
        </section>
        
        <section class="features">
            <h2>Features</h2>
            <div class="feature-grid">
                <div class="feature">
                    <h3>Feature 1</h3>
                    <p>Description of feature 1</p>
                </div>
                <div class="feature">
                    <h3>Feature 2</h3>
                    <p>Description of feature 2</p>
                </div>
                <div class="feature">
                    <h3>Feature 3</h3>
                    <p>Description of feature 3</p>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <p>&copy; ${new Date().getFullYear()} ${state.projectName}</p>
    </footer>
    
    <script src="script.js"><\/script>
</body>
</html>`;

                cssContent = `/* Modern CSS for ${state.projectName} */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    color: #333;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

header {
    background: rgba(255, 255, 255, 0.95);
    padding: 2rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

header h1 {
    font-size: 2.5rem;
    color: #3b82f6;
    margin-bottom: 0.5rem;
}

header p {
    color: #64748b;
}

main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.hero {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 3rem;
}

.hero h2 {
    font-size: 2.2rem;
    margin-bottom: 1rem;
    color: #1e293b;
}

.hero p {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    color: #64748b;
}

.cta-button {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 50px;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
}

.cta-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
}

.features {
    background: white;
    padding: 3rem 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.features h2 {
    text-align: center;
    margin-bottom: 2rem;
    color: #1e293b;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.feature {
    background: #f8fafc;
    padding: 2rem;
    border-radius: 10px;
    text-align: center;
    transition: transform 0.3s;
}

.feature:hover {
    transform: translateY(-5px);
}

.feature h3 {
    color: #3b82f6;
    margin-bottom: 1rem;
}

footer {
    text-align: center;
    padding: 2rem;
    margin-top: 3rem;
    color: #64748b;
}

/* Responsive Design */
@media (max-width: 768px) {
    header h1 {
        font-size: 2rem;
    }
    
    .hero {
        padding: 2rem 1rem;
    }
    
    .hero h2 {
        font-size: 1.8rem;
    }
    
    .feature-grid {
        grid-template-columns: 1fr;
    }
}`;

                jsContent = `// JavaScript for ${state.projectName}
document.addEventListener('DOMContentLoaded', function() {
    // Add interactive functionality
    const ctaButton = document.querySelector('.cta-button');
    
    if (ctaButton) {
        ctaButton.addEventListener('click', function() {
            alert('Welcome to ${state.projectName}! This website was generated by Buddy AI.');
        });
    }
    
    // Animate features on scroll
    const animateFeatures = function() {
        const features = document.querySelectorAll('.feature');
        
        features.forEach(feature => {
            const featurePosition = feature.getBoundingClientRect().top;
            const screenPosition = window.innerHeight / 1.3;
            
            if (featurePosition < screenPosition) {
                feature.style.opacity = 1;
                feature.style.transform = 'translateY(0)';
            }
        });
    };
    
    // Set initial state for animation
    document.querySelectorAll('.feature').forEach(feature => {
        feature.style.opacity = 0;
        feature.style.transform = 'translateY(20px)';
        feature.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    });
    
    // Listen for scroll events
    window.addEventListener('scroll', animateFeatures);
    // Trigger once on load
    animateFeatures();
    
    console.log('${state.projectName} loaded successfully!');
});`;
            }
            
            // Clear existing files
            state.files = {
                '/': {
                    type: 'folder',
                    name: state.projectName.toLowerCase().replace(/\s+/g, '-'),
                    path: '/',
                    children: []
                }
            };
            
            // Create files from demo content
            const files = [
                { name: 'index.html', type: 'file', content: htmlContent },
                { name: 'style.css', type: 'file', content: cssContent },
                { name: 'script.js', type: 'file', content: jsContent }
            ];
            
            // Add files to state
            files.forEach((file, index) => {
                const path = `/${file.name}`;
                state.files[path] = {
                    type: file.type,
                    name: file.name,
                    path: path,
                    content: file.content
                };
                state.files['/'].children.push(path);
                
                // If this is the first file, open it
                if (index === 0) {
                    state.currentFile = file.name;
                }
            });
            
            // Update UI
            renderFileTree();
            updateCodeEditor();
            updatePreview();
            
            // Save state
            saveState();
        }

        // Process AI response and create files
        function processAIResponse(response) {
            // Clear existing files
            state.files = {
                '/': {
                    type: 'folder',
                    name: state.projectName.toLowerCase().replace(/\s+/g, '-'),
                    path: '/',
                    children: []
                }
            };
            
            // Extract HTML, CSS, and JS from response
            const htmlMatch = response.match(/```html\n([\s\S]*?)\n```/) || response.match(/<!DOCTYPE html>[\s\S]*?<\/html>/i);
            const cssMatch = response.match(/```css\n([\s\S]*?)\n```/) || response.match(/<style>([\s\S]*?)<\/style>/i);
            const jsMatch = response.match(/```javascript\n([\s\S]*?)\n```/) || response.match(/<script>([\s\S]*?)<\/script>/i);
            
            // Generate basic project structure based on AI response
            const files = [
                { 
                    name: 'index.html', 
                    type: 'file', 
                    content: htmlMatch ? htmlMatch[1] || htmlMatch[0] : generateHtmlTemplate() 
                },
                { 
                    name: 'style.css', 
                    type: 'file', 
                    content: cssMatch ? cssMatch[1] || cssMatch[0] : generateCssTemplate() 
                },
                { 
                    name: 'script.js', 
                    type: 'file', 
                    content: jsMatch ? jsMatch[1] || jsMatch[0] : generateJsTemplate() 
                }
            ];
            
            // Add files to state
            files.forEach((file, index) => {
                const path = `/${file.name}`;
                state.files[path] = {
                    type: file.type,
                    name: file.name,
                    path: path,
                    content: file.content
                };
                state.files['/'].children.push(path);
                
                // Update UI
                renderFileTree();
                
                // If this is the first file, open it
                if (index === 0) {
                    state.currentFile = file.name;
                    updateCodeEditor();
                }
            });
            
            // Save state
            saveState();
        }

        // Add thinking animation to chat with timer
        function addThinkingAnimation() {
            const id = Date.now();
            const thinkingHtml = `
                <div id="thinking-${id}" class="chat-bubble rounded-lg p-3 bg-slate-800 border-l-4 border-emerald-500">
                    <div class="font-medium text-emerald-400">Buddy AI</div>
                    <div class="mt-1 thinking-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <div class="thinking-timer" id="thinking-timer-${id}">Thinking: 0s</div>
                </div>
            `;
            
            chatMessages.innerHTML += thinkingHtml;
            mobileChatMessages.innerHTML += thinkingHtml;
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            mobileChatMessages.scrollTop = mobileChatMessages.scrollHeight;
            
            // Start timer
            const startTime = Date.now();
            state.thinkingTimers[id] = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = document.getElementById(`thinking-timer-${id}`);
                if (timerElement) {
                    timerElement.textContent = `Thinking: ${elapsed}s`;
                }
            }, 1000);
            
            return id;
        }

        // Remove thinking animation and timer
        function removeThinkingAnimation(id) {
            const thinkingElem = document.getElementById(`thinking-${id}`);
            const mobileThinkingElem = document.getElementById(`thinking-${id}`);
            
            if (thinkingElem) thinkingElem.remove();
            if (mobileThinkingElem) mobileThinkingElem.remove();
            
            // Clear timer
            if (state.thinkingTimers[id]) {
                clearInterval(state.thinkingTimers[id]);
                delete state.thinkingTimers[id];
            }
        }

        // Add chat message with action buttons
        function addChatMessage(role, content) {
            const message = {
                id: Date.now(),
                role,
                content,
                timestamp: new Date()
            };
            
            state.chatHistory.push(message);
            
            // Update UI
            renderChatMessage(message);
            
            // Save state
            saveState();
            
            return message.id;
        }

        // Render chat message with action buttons
        function renderChatMessage(message) {
            const isUser = message.role === 'user';
            const messageHtml = `
                <div id="message-${message.id}" class="chat-bubble rounded-lg p-3 ${isUser ? 'bg-slate-800 border-l-4 border-blue-500' : 'bg-slate-800 border-l-4 border-emerald-500'}">
                    <div class="font-medium ${isUser ? 'text-blue-400' : 'text-emerald-400'}">${isUser ? 'You' : 'Buddy AI'}</div>
                    <div class="mt-1 message-content">${formatMessageContent(message.content)}</div>
                    <div class="chat-bubble-actions">
                        ${isUser ? `
                            <button class="action-btn edit-chat" data-id="${message.id}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn copy-chat" data-id="${message.id}" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn delete-chat" data-id="${message.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="action-btn regenerate-chat" data-id="${message.id}" title="Regenerate">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="action-btn copy-chat" data-id="${message.id}" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn delete-chat" data-id="${message.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            const mobileMessageHtml = `
                <div id="mobile-message-${message.id}" class="chat-bubble rounded-lg p-3 ${isUser ? 'bg-slate-800 border-l-4 border-blue-500' : 'bg-slate-800 border-l-4 border-emerald-500'}">
                    <div class="font-medium ${isUser ? 'text-blue-400' : 'text-emerald-400'}">${isUser ? 'You' : 'Buddy AI'}</div>
                    <div class="mt-1 message-content">${formatMessageContent(message.content)}</div>
                    <div class="chat-bubble-actions">
                        ${isUser ? `
                            <button class="action-btn edit-chat" data-id="${message.id}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn copy-chat" data-id="${message.id}" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn delete-chat" data-id="${message.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="action-btn regenerate-chat" data-id="${message.id}" title="Regenerate">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="action-btn copy-chat" data-id="${message.id}" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn delete-chat" data-id="${message.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += messageHtml;
            mobileChatMessages.innerHTML += mobileMessageHtml;
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            mobileChatMessages.scrollTop = mobileChatMessages.scrollHeight;
            
            // Add event listeners to action buttons
            document.querySelectorAll(`.edit-chat[data-id="${message.id}"]`).forEach(btn => {
                btn.addEventListener('click', () => editChatMessage(message.id));
            });
            
            document.querySelectorAll(`.copy-chat[data-id="${message.id}"]`).forEach(btn => {
                btn.addEventListener('click', () => copyChatMessage(message.id));
            });
            
            document.querySelectorAll(`.delete-chat[data-id="${message.id}"]`).forEach(btn => {
                btn.addEventListener('click', () => deleteChatMessage(message.id));
            });
            
            document.querySelectorAll(`.regenerate-chat[data-id="${message.id}"]`).forEach(btn => {
                btn.addEventListener('click', () => regenerateChatMessage(message.id));
            });
        }

        // Format message content with code highlighting
        function formatMessageContent(content) {
            // Simple code formatting - in a real app you'd use a proper highlighting library
            return content
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-slate-900 p-2 rounded my-2 overflow-x-auto"><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code class="bg-slate-700 px-1 rounded">$1</code>');
        }

        // Handle send chat
        function handleSendChat() {
            const message = chatInput.value.trim() || mobileChatInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addChatMessage('user', message);
            
            // Clear input
            chatInput.value = '';
            mobileChatInput.value = '';
            
            // Use Puter AI to generate response
            generateWithPuter(message);
        }

        // Edit chat message
        function editChatMessage(messageId) {
            const message = state.chatHistory.find(m => m.id === messageId);
            if (!message || message.role !== 'user') return;
            
            // Set input value to message content
            chatInput.value = message.content;
            mobileChatInput.value = message.content;
            
            // Focus on input
            chatInput.focus();
            
            // Remove the message from history
            deleteChatMessage(messageId);
        }

        // Copy chat message
        function copyChatMessage(messageId) {
            const message = state.chatHistory.find(m => m.id === messageId);
            if (!message) return;
            
            navigator.clipboard.writeText(message.content)
                .then(() => {
                    showNotification('Message copied to clipboard');
                })
                .catch(err => {
                    console.error('Failed to copy message: ', err);
                    showNotification('Failed to copy message', 'error');
                });
        }

        // Delete chat message
        function deleteChatMessage(messageId) {
            state.chatHistory = state.chatHistory.filter(m => m.id !== messageId);
            
            // Re-render chat messages
            chatMessages.innerHTML = '';
            mobileChatMessages.innerHTML = '';
            state.chatHistory.forEach(msg => renderChatMessage(msg));
            
            // Save state
            saveState();
        }

        // Regenerate chat message
        function regenerateChatMessage(messageId) {
            const message = state.chatHistory.find(m => m.id === messageId);
            if (!message || message.role !== 'ai') return;
            
            // Find the user message that preceded this AI response
            const messageIndex = state.chatHistory.findIndex(m => m.id === messageId);
            if (messageIndex > 0) {
                const userMessage = state.chatHistory[messageIndex - 1];
                if (userMessage.role === 'user') {
                    // Remove the AI message
                    deleteChatMessage(messageId);
                    
                    // Regenerate response
                    generateWithPuter(userMessage.content);
                }
            }
        }

        // Render file tree with edit icons
        function renderFileTree() {
            const root = state.files['/'];
            if (!root) return;
            
            let html = `
                <div class="file-item folder" data-path="/">
                    <span class="file-icon"><i class="fas fa-folder text-yellow-400"></i></span>
                    <span class="file-name">${root.name}</span>
                    <span class="file-edit-icon" title="Rename folder">
                        <i class="fas fa-pencil-alt text-slate-400"></i>
                    </span>
                </div>
                <div class="file-tree ml-4">
            `;
            
            root.children.forEach(childPath => {
                const file = state.files[childPath];
                if (file) {
                    const icon = getFileIcon(file.name);
                    const isActive = state.currentFile === file.name;
                    
                    html += `
                        <div class="file-item ${isActive ? 'bg-slate-800' : ''}" data-path="${file.path}">
                            <span class="file-icon">${icon}</span>
                            <span class="file-name">${file.name}</span>
                            <span class="file-edit-icon" title="Rename file">
                                <i class="fas fa-pencil-alt text-slate-400"></i>
                            </span>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            fileTree.innerHTML = html;
            mobileFileTree.innerHTML = html;
            
            // Add event listeners to file items
            document.querySelectorAll('.file-item').forEach(item => {
                const path = item.dataset.path;
                const file = state.files[path];
                
                if (file && file.type === 'file') {
                    item.addEventListener('click', () => {
                        state.currentFile = file.name;
                        updateCodeEditor();
                        
                        // Update active file highlighting
                        document.querySelectorAll('.file-item').forEach(i => i.classList.remove('bg-slate-800'));
                        item.classList.add('bg-slate-800');
                    });
                }
                
                // Add event listeners for edit icons
                const editIcon = item.querySelector('.file-edit-icon');
                if (editIcon) {
                    editIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showRenameModal(path);
                    });
                }
            });
        }

        // Show rename modal
        function showRenameModal(path) {
            const file = state.files[path];
            if (!file) return;
            
            renameInput.value = file.name;
            renameModal.classList.remove('hidden');
            
            // Store the current path for the rename operation
            renameModal.dataset.path = path;
        }

        // Handle rename confirm
        function handleRenameConfirm() {
            const newName = renameInput.value.trim();
            const path = renameModal.dataset.path;
            
            if (!newName) {
                showNotification('Please enter a name', 'error');
                return;
            }
            
            const file = state.files[path];
            if (!file) return;
            
            // Check if the new name is the same as the current name
            if (newName === file.name) {
                renameModal.classList.add('hidden');
                return;
            }
            
            // Check if a file/folder with the new name already exists
            const newPath = `/${newName}`;
            if (state.files[newPath]) {
                showNotification('A file or folder with this name already exists', 'error');
                return;
            }
            
            // Update the file/folder name
            file.name = newName;
            
            // If it's a file, update the extension if needed
            if (file.type === 'file') {
                const extension = newName.split('.').pop();
                if (extension && !newName.endsWith(`.${extension}`)) {
                    file.name = `${newName}.${extension}`;
                }
            }
            
            // Update UI
            renderFileTree();
            
            // If the renamed file is the current file, update the editor
            if (state.currentFile === path.split('/').pop()) {
                state.currentFile = file.name;
                updateCodeEditor();
            }
            
            // Close modal
            renameModal.classList.add('hidden');
            
            // Save state
            saveState();
            
            showNotification('Name updated successfully');
        }

        // Get file icon based on file extension
        function getFileIcon(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            switch (extension) {
                case 'html':
                    return '<i class="fab fa-html5 text-orange-500"></i>';
                case 'css':
                    return '<i class="fab fa-css3-alt text-blue-500"></i>';
                case 'js':
                    return '<i class="fab fa-js-square text-yellow-400"></i>';
                case 'json':
                    return '<i class="fas fa-file-code text-yellow-300"></i>';
                case 'md':
                    return '<i class="fas fa-book text-blue-300"></i>';
                default:
                    return '<i class="fas fa-file text-gray-400"></i>';
            }
        }

        // Update code editor
        function updateCodeEditor() {
            const file = state.files[`/${state.currentFile}`];
            if (!file) return;
            
            currentFile.textContent = file.name;
            codeEditor.textContent = file.content;
            
            // Update editor header filename
            const editorHeader = codeEditor.parentElement.querySelector('.editor-header .text-xs');
            if (editorHeader) {
                editorHeader.textContent = file.name;
            }
            
            // Apply basic syntax highlighting
            applySyntaxHighlighting();
        }

        // Apply basic syntax highlighting
        function applySyntaxHighlighting() {
            const fileExtension = state.currentFile.split('.').pop().toLowerCase();
            let content = codeEditor.textContent;
            
            // Very basic highlighting for demo purposes
            // In a real app, you'd use a library like Prism.js or Highlight.js
            if (fileExtension === 'html') {
                content = content
                    .replace(/&lt;!DOCTYPE([^&]*)&gt;/g, '<span class="token doctype">&lt;!DOCTYPE$1&gt;</span>')
                    .replace(/&lt;(\/?)([a-zA-Z0-9-]+)([^&]*)&gt;/g, '&lt;$1<span class="token tag">$2</span>$3&gt;')
                    .replace(/([a-zA-Z-]+)=/g, '<span class="token attribute">$1</span>=')
                    .replace(/&quot;([^&]*)&quot;/g, '<span class="token string">&quot;$1&quot;</span>');
            } else if (fileExtension === 'css') {
                content = content
                    .replace(/([\.#]?[a-zA-Z0-9-]+\s*){/g, '<span class="token selector">$1</span>{')
                    .replace(/([a-zA-Z-]+):/g, '<span class="token property">$1</span>:')
                    .replace(/:(.*?);/g, ':<span class="token value">$1</span>;');
            } else if (fileExtension === 'js') {
                content = content
                    .replace(/\b(function|var|let|const|if|else|for|while|return|class|import|export|from)\b/g, '<span class="token keyword">$1</span>')
                    .replace(/(".*?"|'.*?')/g, '<span class="token string">$1</span>')
                    .replace(/(\/\/.*)/g, '<span class="token comment">$1</span>');
            }
            
            codeEditor.innerHTML = content;
        }

        // Update preview
        function updatePreview() {
            const htmlFile = state.files['/index.html'];
            const cssFile = state.files['/style.css'];
            const jsFile = state.files['/script.js'];
            
            if (!htmlFile) return;
            
            let htmlContent = htmlFile.content;
            
            // Inject CSS if available
            if (cssFile) {
                const styleTag = `<style>${cssFile.content}</style>`;
                if (htmlContent.includes('</head>')) {
                    htmlContent = htmlContent.replace('</head>', `${styleTag}</head>`);
                } else if (htmlContent.includes('<head>')) {
                    htmlContent = htmlContent.replace('<head>', `<head>${styleTag}`);
                } else {
                    htmlContent = `<head>${styleTag}</head>${htmlContent}`;
                }
            }
            
            // Inject JS if available
            if (jsFile) {
                const scriptTag = `<script>${jsFile.content.replace(/<\/script>/g, '<\\/script>')}<\/script>`;
                if (htmlContent.includes('</body>')) {
                    htmlContent = htmlContent.replace('</body>', `${scriptTag}</body>`);
                } else if (htmlContent.includes('<body>')) {
                    htmlContent = htmlContent.replace('<body>', `<body>${scriptTag}`);
                } else {
                    htmlContent += scriptTag;
                }
            }
            
            // Update preview
            websitePreview.srcdoc = htmlContent;
        }

        // Set preview device
        function setPreviewDevice(device) {
            const previewWrapper = document.getElementById('preview-wrapper');
            switch (device) {
                case 'mobile':
                    previewWrapper.className = 'w-full h-full flex justify-center p-4';
                    websitePreview.className = 'w-full h-full border border-slate-200 rounded-lg';
                    websitePreview.style.maxWidth = '375px';
                    websitePreview.style.maxHeight = '667px';
                    break;
                case 'tablet':
                    previewWrapper.className = 'w-full h-full flex justify-center p-4';
                    websitePreview.className = 'w-full h-full border border-slate-200 rounded-lg';
                    websitePreview.style.maxWidth = '768px';
                    websitePreview.style.maxHeight = '1024px';
                    break;
                case 'desktop':
                    previewWrapper.className = 'w-full h-full flex justify-center p-4';
                    websitePreview.className = 'w-full h-full border border-slate-200 rounded-lg';
                    websitePreview.style.maxWidth = '100%';
                    websitePreview.style.maxHeight = '100%';
                    break;
            }
        }

        // Show file modal
        function showFileModal(type) {
            fileModal.classList.remove('hidden');
            if (type === 'file') {
                fileModalTitle.textContent = 'Create New File';
                fileTypeContainer.classList.remove('hidden');
            } else {
                fileModalTitle.textContent = 'Create New Folder';
                fileTypeContainer.classList.add('hidden');
            }
        }

        // Handle file modal confirm
        function handleFileModalConfirm() {
            const name = fileNameInput.value.trim();
            if (!name) {
                showNotification('Please enter a name', 'error');
                return;
            }
            
            const isFile = !fileTypeContainer.classList.contains('hidden');
            const type = isFile ? 'file' : 'folder';
            const extension = isFile ? fileTypeSelect.value : '';
            const fullName = isFile && !name.endsWith(`.${extension}`) ? `${name}.${extension}` : name;
            const path = `/${fullName}`;
            
            // Check if file/folder already exists
            if (state.files[path]) {
                showNotification('A file or folder with this name already exists', 'error');
                return;
            }
            
            // Add to state
            state.files[path] = {
                type,
                name: fullName,
                path,
                content: type === 'file' ? getFileTemplate(extension) : ''
            };
            
            state.files['/'].children.push(path);
            
            // Update UI
            renderFileTree();
            
            // Close modal
            fileModal.classList.add('hidden');
            fileNameInput.value = '';
            
            // Save state
            saveState();
            
            showNotification(`${type === 'file' ? 'File' : 'Folder'} created successfully`);
        }

        // Confirm file deletion
        function confirmDeleteFile(path) {
            const file = state.files[path];
            if (!file) return;
            
            // Don't allow deletion of root folder
            if (path === '/') return;
            
            modalTitle.textContent = 'Delete File';
            modalMessage.textContent = `Are you sure you want to delete "${file.name}"? This action cannot be undone.`;
            confirmationModal.classList.remove('hidden');
            
            modalConfirm.onclick = () => {
                // Remove file from state
                delete state.files[path];
                
                // Remove from parent's children array
                const parentPath = '/';
                if (state.files[parentPath]) {
                    state.files[parentPath].children = state.files[parentPath].children.filter(child => child !== path);
                }
                
                // If deleted file was the current file, switch to index.html
                if (state.currentFile === file.name) {
                    state.currentFile = 'index.html';
                    updateCodeEditor();
                }
                
                // Update UI
                renderFileTree();
                
                // Close modal
                confirmationModal.classList.add('hidden');
                
                // Save state
                saveState();
                
                showNotification('File deleted successfully');
            };
        }

        // Get file template based on extension
        function getFileTemplate(extension) {
            switch (extension) {
                case 'html':
                    return generateHtmlTemplate();
                case 'css':
                    return generateCssTemplate();
                case 'js':
                    return generateJsTemplate();
                default:
                    return '';
            }
        }

        // Generate HTML template
        function generateHtmlTemplate() {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${state.projectName}</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Welcome to ${state.projectName}</h1>
    </header>
    <main>
        <section class="hero">
            <h2>Modern, Colorful UI</h2>
            <p>This project was generated by Buddy AI</p>
            <button class="cta-button">Get Started</button>
        </section>
    </main>
    <script src="script.js"><\/script>
</body>
</html>`;
        }

        // Generate CSS template
        function generateCssTemplate() {
            return `/* Modern, colorful styles for ${state.projectName} */
body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    min-height: 100vh;
}

header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 1rem;
    text-align: center;
}

.hero {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    text-align: center;
    color: white;
}

.cta-button {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
}

.cta-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}`;
        }

        // Generate JavaScript template
        function generateJsTemplate() {
            return `// JavaScript for ${state.projectName}
document.addEventListener('DOMContent', function() {
    const ctaButton = document.querySelector('.cta-button');
    
    if (ctaButton) {
        ctaButton.addEventListener('click', function() {
            alert('Welcome to your new project! This alert was triggered by JavaScript.');
        });
    }
    
    console.log('${state.projectName} loaded successfully!');
});`;
        }

        // Copy code to clipboard
        function copyCodeToClipboard() {
            const file = state.files[`/${state.currentFile}`];
            if (!file) return;
            
            navigator.clipboard.writeText(file.content)
                .then(() => {
                    // Show success message
                    showNotification('Code copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy code: ', err);
                    showNotification('Failed to copy code to clipboard', 'error');
                });
        }

        // Undo code edit
        function undoCodeEdit() {
            if (state.undoStack.length > 0) {
                const previousState = state.undoStack.pop();
                state.redoStack.push(state.files[`/${state.currentFile}`].content);
                state.files[`/${state.currentFile}`].content = previousState;
                updateCodeEditor();
                updatePreview();
                saveState();
            }
        }

        // Redo code edit
        function redoCodeEdit() {
            if (state.redoStack.length > 0) {
                const nextState = state.redoStack.pop();
                state.undoStack.push(state.files[`/${state.currentFile}`].content);
                state.files[`/${state.currentFile}`].content = nextState;
                updateCodeEditor();
                updatePreview();
                saveState();
            }
        }

        // Create new project
        function createNewProject() {
            // Reset state
            state.projectName = 'New Project';
            state.currentFile = 'index.html';
            state.files = {
                '/': {
                    type: 'folder',
                    name: 'new-project',
                    path: '/',
                    children: ['/index.html', '/style.css', '/script.js']
                },
                '/index.html': {
                    type: 'file',
                    name: 'index.html',
                    path: '/index.html',
                    content: generateHtmlTemplate()
                },
                '/style.css': {
                    type: 'file',
                    name: 'style.css',
                    path: '/style.css',
                    content: generateCssTemplate()
                },
                '/script.js': {
                    type: 'file',
                    name: 'script.js',
                    path: '/script.js',
                    content: generateJsTemplate()
                }
            };
            state.chatHistory = [];
            state.undoStack = [];
            state.redoStack = [];
            
            // Update UI
            projectNameInput.value = state.projectName;
            currentProjectNameMenu.textContent = state.projectName;
            chatMessages.innerHTML = '';
            mobileChatMessages.innerHTML = '';
            renderFileTree();
            updateCodeEditor();
            updatePreview();
            
            // Save state
            saveState();
            
            // Show notification
            showNotification('New project created');
        }

        // Confirm delete project
        function confirmDeleteProject() {
            modalTitle.textContent = 'Delete Project';
            modalMessage.textContent = 'Are you sure you want to delete this project? This action cannot be undone.';
            confirmationModal.classList.remove('hidden');
            
            modalConfirm.onclick = () => {
                confirmationModal.classList.add('hidden');
                createNewProject();
            };
        }

        // Save project to storage
        function saveProjectToStorage() {
            try {
                localStorage.setItem('buddyAIProject', JSON.stringify(state));
                showNotification('Project saved successfully');
            } catch (e) {
                console.error('Error saving project:', e);
                showNotification('Error saving project. Local storage may be full.', 'error');
            }
        }

        // Download project as ZIP
        function downloadProjectAsZip() {
            try {
                const zip = new JSZip();
                const root = state.files['/'];
                
                // Add all files to ZIP
                root.children.forEach(childPath => {
                    const file = state.files[childPath];
                    if (file && file.type === 'file') {
                        zip.file(file.name, file.content);
                    }
                });
                
                // Generate and download ZIP
                zip.generateAsync({ type: 'blob' })
                    .then(content => {
                        saveAs(content, `${state.projectName.toLowerCase().replace(/\s+/g, '-')}.zip`);
                        showNotification('Project downloaded successfully');
                    })
                    .catch(error => {
                        console.error('Error generating ZIP:', error);
                        showNotification('Error generating project download', 'error');
                    });
            } catch (error) {
                console.error('Error downloading project:', error);
                showNotification('Error downloading project', 'error');
            }
        }

        // Export chat to PDF
        function exportChatToPdf() {
            try {
                const element = document.createElement('div');
                element.innerHTML = `
                    <h1>Chat Export - ${state.projectName}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                    ${state.chatHistory.map(msg => `
                        <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <strong>${msg.role === 'user' ? 'You' : 'Buddy AI'}</strong> 
                            <span style="color: #666; font-size: 0.9em;">(${new Date(msg.timestamp).toLocaleString()})</span>:<br>
                            <div style="margin-top: 5px;">${msg.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `).join('')}
                `;
                
                const opt = {
                    margin: 1,
                    filename: `buddy-ai-chat-${new Date().toISOString().slice(0, 10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                html2pdf()
                    .set(opt)
                    .from(element)
                    .save();
                
                showNotification('Chat exported to PDF');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showNotification('Error exporting chat to PDF', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 transform translate-y-8 opacity-0 ${
                type === 'success' ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'
            }`;
            notification.textContent = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-8', 'opacity-0');
                notification.classList.add('translate-y-0', 'opacity-100');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-y-8', 'opacity-0');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Load state from localStorage
        function loadState() {
            try {
                const savedState = localStorage.getItem('buddyAIProject');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    Object.assign(state, parsedState);
                    
                    // Update UI based on loaded state
                    if (state.currentPage === 'builder') {
                        welcomePage.classList.add('hidden');
                        builderPage.classList.remove('hidden');
                    }
                    
                    projectNameInput.value = state.projectName;
                    currentProjectNameMenu.textContent = state.projectName;
                    
                    // Render chat history
                    state.chatHistory.forEach(msg => renderChatMessage(msg));
                    
                    // Render file tree
                    renderFileTree();
                    
                    // Update code editor
                    updateCodeEditor();
                    
                    // Update preview
                    updatePreview();
                }
            } catch (error) {
                console.error('Error loading saved state:', error);
                showNotification('Error loading saved project', 'error');
            }
        }

        // Save state to localStorage
        function saveState() {
            try {
                // Push current content to undo stack before saving
                if (state.files[`/${state.currentFile}`]) {
                    state.undoStack.push(state.files[`/${state.currentFile}`].content);
                    // Keep only the last 50 states
                    if (state.undoStack.length > 50) {
                        state.undoStack.shift();
                    }
                    // Clear redo stack when new changes are made
                    state.redoStack = [];
                }
                
                localStorage.setItem('buddyAIProject', JSON.stringify(state));
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
