<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buddy AI — Project Builder</title>

  <!-- Puter.js -->
  <script src="https://js.puter.com/v2/"></script>

  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* (Your existing CSS from the original file) */
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #1d232c;
      --accent-primary: #6aa6ff;
      --accent-secondary: #9b6bff;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --border: #30363d;
      --success: #3ad29f;
      --warning: #ffcc66;
      --error: #ff6b6b;
      --control-height: 44px;
      --sidebar-width: 280px;
      --radius: 12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);display:flex;height:100vh;overflow:hidden;background-image:radial-gradient(ellipse at 10% -10%, rgba(106,166,255,0.1), transparent 50%),radial-gradient(ellipse at 90% -20%, rgba(155,107,255,0.08), transparent 50%)}
    .sidebar{width:var(--sidebar-width);background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100%;z-index:100;transition:transform .3s}
    .sidebar-header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
    .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:8px;display:flex;align-items:center;justify-content:center}
    .sidebar-content{flex:1;overflow-y:auto;padding:16px}
    .section-title{font-size:14px;font-weight:600;text-transform:uppercase;color:var(--text-secondary);margin-bottom:12px;letter-spacing:.5px}
    .new-chat-btn{width:100%;padding:12px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-weight:500;cursor:pointer;display:flex;align-items:center;gap:8px}
    .conversation-list{display:flex;flex-direction:column;gap:8px}
    .conversation-item{padding:12px;border-radius:var(--radius);cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:10px}
    .conversation-item.active{background:rgba(106,166,255,0.15)}
    .conversation-icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center}
    .conversation-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .topbar{padding:16px 24px;display:flex;align-items:center;gap:16px;border-bottom:1px solid var(--border);background:rgba(22,27,34,.8);backdrop-filter:blur(8px);z-index:10}
    .chat-container{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px}
    .message{max-width:800px;width:100%;display:flex;gap:16px;padding:16px;border-radius:var(--radius);background:var(--bg-secondary);border:1px solid var(--border);animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message.user{align-self:flex-end;border-left:3px solid var(--accent-primary)}
    .message.assistant{border-left:3px solid var(--success)}
    .avatar{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .user .avatar{background:rgba(106,166,255,.15);color:var(--accent-primary)}
    .assistant .avatar{background:rgba(58,210,159,.15);color:var(--success)}
    .message-content{flex:1}
    .message-header{font-weight:600;margin-bottom:8px}
    .message-body{line-height:1.6}
    .message-body pre{background:rgba(16,20,26,.8);border-radius:8px;padding:16px;overflow-x:auto;margin:12px 0;font-family:Fira Code,monospace;font-size:14px;border:1px solid var(--border)}
    .composer{padding:16px 24px;background:rgba(22,27,34,.8);backdrop-filter:blur(8px);border-top:1px solid var(--border)}
    .composer-inner{max-width:800px;margin:0 auto;display:flex;gap:12px}
    .composer textarea{flex:1;min-height:var(--control-height);padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-family:inherit;font-size:15px;resize:none;outline:none;transition:border-color .2s}
    .send-btn{width:var(--control-height);height:var(--control-height);background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;border-radius:var(--radius);color:white;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .build-btn{width:var(--control-height);height:var(--control-height);background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .builder-panel{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);z-index:1000;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s}
    .builder-panel.active{transform:translateY(0)}
    .builder-header{padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);background:var(--bg-secondary)}
    .builder-main{flex:1;display:flex;overflow:hidden}
    .file-explorer{width:280px;background:var(--bg-secondary);border-right:1px solid var(--border);padding:16px;overflow-y:auto}
    .file-list{display:flex;flex-direction:column;gap:4px}
    .file-item{padding:10px 12px;border-radius:var(--radius);display:flex;align-items:center;gap:8px;cursor:pointer}
    .file-item:hover{background:var(--bg-tertiary)}
    .file-item.active{background:rgba(106,166,255,.15)}
    .editor-preview-container{flex:1;display:flex;flex-direction:column}
    .editor-tabs{display:flex;background:var(--bg-secondary);border-bottom:1px solid var(--border)}
    .editor-tab{padding:12px 20px;cursor:pointer;font-weight:500;border-bottom:2px solid transparent}
    .editor-tab.active{border-bottom:2px solid var(--accent-primary);color:var(--accent-primary)}
    .editor-content{flex:1;display:flex;overflow:hidden}
    .editor-pane{flex:1;display:flex;flex-direction:column}
    .code-editor{flex:1;background:var(--bg-tertiary);color:var(--text-primary);padding:16px;border:none;outline:none;font-family:Fira Code,monospace;font-size:14px;resize:none}
    .editor-actions{padding:12px 16px;display:flex;justify-content:flex-end;gap:12px;background:var(--bg-secondary);border-top:1px solid var(--border)}
    .editor-btn{padding:8px 16px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px}
    .editor-btn.primary{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:white}
    .preview-pane{flex:1;display:none;background:white;position:relative}
    .preview-pane.active{display:block}
    .preview-frame{width:100%;height:100%;border:none}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-robot"></i>
        </div>
        <span>Buddy AI</span>
      </div>
    </div>

    <div class="sidebar-content">
      <div class="sidebar-section">
        <button id="newChat" class="new-chat-btn"><i class="fas fa-plus"></i> New Chat</button>
      </div>

      <div class="sidebar-section">
        <div class="section-title">Conversations</div>
        <div class="conversation-list">
          <div class="conversation-item active">
            <div class="conversation-icon"><i class="fas fa-comment"></i></div>
            <div class="conversation-name">Website Builder</div>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-title">Models</div>
        <div class="model-list">
          <div class="conversation-item"><div class="conversation-icon"><i class="fas fa-brain"></i></div><div class="conversation-name">GPT-4 / GPT-4o</div></div>
          <div class="conversation-item"><div class="conversation-icon"><i class="fas fa-brain"></i></div><div class="conversation-name">Claude 3.5</div></div>
          <div class="conversation-item"><div class="conversation-icon"><i class="fas fa-brain"></i></div><div class="conversation-name">Grok</div></div>
          <div class="conversation-item"><div class="conversation-icon"><i class="fas fa-brain"></i></div><div class="conversation-name">Deepseek</div></div>
          <div class="conversation-item"><div class="conversation-icon"><i class="fas fa-brain"></i></div><div class="conversation-name">Llama</div></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="topbar">
      <div class="current-conversation">Website Builder</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="signInBtn" class="build-btn" title="Sign in to Puter">Sign in</button>
        <button id="buildBtn" class="build-btn" title="Start project build"><i class="fas fa-hammer"></i></button>
      </div>
    </div>

    <div class="chat-container" id="chatContainer">
      <!-- Initial assistant message -->
      <div class="message assistant">
        <div class="avatar"><i class="fas fa-robot"></i></div>
        <div class="message-content">
          <div class="message-header">Buddy AI</div>
          <div class="message-body">
            <p>Welcome! Click <strong>Sign in</strong> to connect Puter, then click the hammer to run the multi-AI project builder. You'll be asked to confirm model usage if cost applies.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="composer">
      <div class="composer-inner">
        <textarea id="promptInput" placeholder="Describe what you want Buddy to build (e.g. 'Modern SaaS landing page with auth and hosting')"></textarea>
        <button id="buildOpen" class="build-btn" title="Open builder panel"><i class="fas fa-hammer"></i></button>
        <button id="sendBtn" class="send-btn" title="Send prompt"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <!-- Builder Panel -->
    <div id="builderPanel" class="builder-panel">
      <div class="builder-header">
        <div class="builder-title">Project Builder</div>
        <button id="closeBuilder" class="close-builder"><i class="fas fa-times"></i></button>
      </div>

      <div class="builder-main">
        <div class="file-explorer">
          <div class="file-explorer-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="margin:0">Project Files</h3>
            <div class="file-actions">
              <button id="newFileBtn" class="file-action-btn" title="New file"><i class="fas fa-file"></i></button>
              <button id="newFolderBtn" class="file-action-btn" title="New folder"><i class="fas fa-folder"></i></button>
            </div>
          </div>

          <div class="file-list" id="fileList">
            <!-- populated dynamically -->
          </div>
        </div>

        <div class="editor-preview-container">
          <div class="editor-tabs">
            <div id="tabEditor" class="editor-tab active">Editor</div>
            <div id="tabPreview" class="editor-tab">Preview</div>
          </div>

          <div class="editor-content">
            <div class="editor-pane" id="editorPane">
              <textarea id="codeEditor" class="code-editor">// Open a project or run build to generate files here.</textarea>

              <div class="editor-actions">
                <button id="saveFileBtn" class="editor-btn"><i class="fas fa-save"></i> Save</button>
                <button id="runProjectBtn" class="editor-btn primary"><i class="fas fa-play"></i> Run Project</button>
                <button id="publishBtn" class="editor-btn"><i class="fas fa-cloud-upload-alt"></i> Publish</button>
              </div>
            </div>

            <div class="preview-pane" id="previewPane">
              <iframe id="previewFrame" class="preview-frame"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
  /**********************************************************************
   * Buddy AI Project Builder
   * - Uses puter.js (browser) to orchestrate 5 AI roles using puter.ai.chat
   * - Creates files in puter.fs and can publish with puter.hosting.create
   *
   * Workflow (high level):
   *  1. Coordinator (model A) decides user's need + breakdown
   *  2. Searcher (model B) gathers external references / URLs
   *  3. Architect (model C) outputs project structure / dependencies
   *  4. Coder (model D) writes files line-by-line and puter.fs.write them
   *  5. Guide/Streamer (model E) provides live status + next steps while files are made
   *
   * Notes:
   * - Puter model availability varies. We will attempt to use these model ids:
   *   -> coordinatorModel = "gpt-4" (primary), fallback "gpt-4o" or "gpt-4.1"
   *   -> searchModel = "grok" (if available) or "gpt-4" / "claude"
   *   -> architectModel = "claude"
   *   -> coderModel = "gpt-4"
   *   -> guideModel = "claude"
   *
   * - If a model isn't available, the code falls back and reports the situation.
   **********************************************************************/

  const chatContainer = document.getElementById('chatContainer');
  const promptInput = document.getElementById('promptInput');
  const sendBtn = document.getElementById('sendBtn');
  const buildBtn = document.getElementById('buildBtn');
  const buildOpen = document.getElementById('buildOpen');
  const signInBtn = document.getElementById('signInBtn');

  const builderPanel = document.getElementById('builderPanel');
  const closeBuilder = document.getElementById('closeBuilder');
  const fileListEl = document.getElementById('fileList');
  const codeEditor = document.getElementById('codeEditor');
  const saveFileBtn = document.getElementById('saveFileBtn');
  const runProjectBtn = document.getElementById('runProjectBtn');
  const publishBtn = document.getElementById('publishBtn');
  const previewPane = document.getElementById('previewPane');
  const previewFrame = document.getElementById('previewFrame');
  const tabEditor = document.getElementById('tabEditor');
  const tabPreview = document.getElementById('tabPreview');

  // Basic app state
  let projectDir = null;
  let activeFilePath = null;
  let fileIndex = {}; // path => {name, content}
  let userSignedIn = false;

  // Default model choices (attempt these in order; Puter may or may not have all)
  const modelCandidates = {
    coordinator: ['gpt-4', 'gpt-4o', 'gpt-4.1', 'claude'],
    searcher: ['grok', 'deepseek', 'gpt-4', 'claude'],
    architect: ['claude', 'gpt-4'],
    coder: ['gpt-4', 'gpt-4o', 'claude'],
    guide: ['claude', 'gpt-4']
  };

  // Utility: push message into chat pane
  function pushMessage(role, header, htmlContent) {
    const msg = document.createElement('div');
    msg.className = 'message ' + (role === 'user' ? 'user' : 'assistant');
    msg.innerHTML = `
      <div class="avatar"><i class="${role === 'user' ? 'fas fa-user' : 'fas fa-robot'}"></i></div>
      <div class="message-content">
        <div class="message-header">${header}</div>
        <div class="message-body">${htmlContent}</div>
      </div>
    `;
    chatContainer.appendChild(msg);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return msg;
  }

  // Sign-in helper using puter.auth.signIn()
  signInBtn.addEventListener('click', async () => {
    try {
      await puter.auth.signIn();
      userSignedIn = true;
      signInBtn.textContent = 'Signed in';
      pushMessage('assistant', 'Buddy AI', '<p>Signed in to Puter.</p>');
    } catch (err) {
      console.error('Sign in failed', err);
      pushMessage('assistant', 'Buddy AI', `<p style="color:var(--error)">Sign in failed: ${err.message || err}</p>`);
    }
  });

  // buildOpen toggles the builder panel
  buildOpen.addEventListener('click', () => builderPanel.classList.toggle('active'));
  closeBuilder.addEventListener('click', () => builderPanel.classList.remove('active'));

  // Tab switching
  tabEditor.addEventListener('click', () => {
    tabEditor.classList.add('active'); tabPreview.classList.remove('active');
    document.getElementById('editorPane').style.display = 'flex';
    previewPane.classList.remove('active');
  });
  tabPreview.addEventListener('click', () => {
    tabPreview.classList.add('active'); tabEditor.classList.remove('active');
    document.getElementById('editorPane').style.display = 'none';
    previewPane.classList.add('active');
  });

  // Save button: write active file to puter.fs if we have projectDir & path
  saveFileBtn.addEventListener('click', async () => {
    if (!projectDir || !activeFilePath) {
      pushMessage('assistant', 'Buddy AI', '<p style="color:var(--warning)">No file selected to save.</p>');
      return;
    }
    try {
      await puter.fs.write(`${projectDir}/${activeFilePath}`, fileIndex[activeFilePath].content);
      pushMessage('assistant', 'Buddy AI', `<p>Saved <strong>${activeFilePath}</strong> to cloud.</p>`);
    } catch (err) {
      console.error(err);
      pushMessage('assistant', 'Buddy AI', `<p style="color:var(--error)">Save failed: ${err.message || err}</p>`);
    }
  });

  // Run project: if hosted, open in preview iframe or run local build by constructing an html blob
  runProjectBtn.addEventListener('click', async () => {
    if (!projectDir) return pushMessage('assistant', 'Buddy AI', '<p style="color:var(--warning)">No project. Run the builder first.</p>');
    // try to read index.html from puter.fs, else build from fileIndex
    try {
      let htmlContent;
      try {
        const blob = await puter.fs.read(`${projectDir}/index.html`);
        htmlContent = await blob.text();
      } catch (e) {
        // fallback: try fileIndex
        htmlContent = fileIndex['index.html']?.content || '<h1>No index.html</h1>';
      }
      // load into iframe as blob URL
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      previewFrame.src = url;
      tabPreview.click();
      pushMessage('assistant', 'Buddy AI', '<p>Preview loaded.</p>');
    } catch (err) {
      console.error(err);
      pushMessage('assistant', 'Buddy AI', `<p style="color:var(--error)">Run failed: ${err.message || err}</p>`);
    }
  });

  // Publish (host) via puter.hosting.create
  publishBtn.addEventListener('click', async () => {
    if (!projectDir) return pushMessage('assistant', 'Buddy AI', '<p style="color:var(--warning)">No project to publish.</p>');
    try {
      const subdomain = 'buddy-' + puter.randName();
      pushMessage('assistant', 'Buddy AI', `<p>Publishing to subdomain <strong>${subdomain}.puter.site</strong> ...</p>`);
      const site = await puter.hosting.create(subdomain, projectDir);
      pushMessage('assistant', 'Buddy AI', `<p>Published: <a href="https://${site.subdomain}.puter.site" target="_blank">https://${site.subdomain}.puter.site</a></p>`);
      previewFrame.src = `https://${site.subdomain}.puter.site`;
      tabPreview.click();
    } catch (err) {
      console.error(err);
      pushMessage('assistant', 'Buddy AI', `<p style="color:var(--error)">Publish failed: ${err.message || err}</p>`);
    }
  });

  // small helper to render file list
  function renderFileList() {
    fileListEl.innerHTML = '';
    Object.keys(fileIndex).forEach(path => {
      const item = document.createElement('div');
      item.className = 'file-item' + (path === activeFilePath ? ' active' : '');
      item.innerHTML = `<i class="fas ${path.endsWith('/') ? 'fa-folder' : 'fa-file-code'}"></i><span style="margin-left:8px">${path}</span>`;
      item.addEventListener('click', () => {
        activeFilePath = path;
        codeEditor.value = fileIndex[path].content;
        renderFileList();
      });
      fileListEl.appendChild(item);
    });
  }

  // Keep codeEditor changes in memory
  codeEditor.addEventListener('input', () => {
    if (!activeFilePath) return;
    fileIndex[activeFilePath].content = codeEditor.value;
  });

  // New file/folder actions (local fileIndex)
  document.getElementById('newFileBtn').addEventListener('click', () => {
    const name = prompt('File name (e.g. index.html):');
    if (!name) return;
    fileIndex[name] = { name, content: '' };
    activeFilePath = name;
    codeEditor.value = '';
    renderFileList();
  });
  document.getElementById('newFolderBtn').addEventListener('click', () => {
    const name = prompt('Folder name (e.g. src/):');
    if (!name) return;
    const folder = name.endsWith('/') ? name : name + '/';
    fileIndex[folder] = { name: folder, content: null };
    renderFileList();
  });

  // Send prompt as plain chat message
  sendBtn.addEventListener('click', () => {
    const text = promptInput.value.trim();
    if (!text) return;
    pushMessage('user', 'You', `<p>${escapeHtml(text)}</p>`);
    promptInput.value = '';
    pushMessage('assistant', 'Buddy AI', '<p>Got it — click the hammer (or Build) to run a full multi-AI build for this prompt.</p>');
  });

  // Primary build button: run orchestration
  buildBtn.addEventListener('click', async () => {
    const userPrompt = (promptInput.value || '').trim();
    if (!userPrompt) {
      pushMessage('assistant', 'Buddy AI', '<p style="color:var(--warning)">Please enter a prompt in the input field describing the project you want (e.g., "Modern SaaS landing page with auth").</p>');
      return;
    }
    if (!puter?.ai?.chat) {
      pushMessage('assistant', 'Buddy AI', '<p style="color:var(--error)">Puter.ai is not available in this environment.</p>');
      console.error('puter.ai.chat not available');
      return;
    }

    // Confirm model usage cost with the user
    const consent = confirm('This builder will call multiple AI models (may use paid API credits). Continue?');
    if (!consent) {
      pushMessage('assistant', 'Buddy AI', '<p style="color:var(--warning)">Cancelled by user.</p>');
      return;
    }

    // Start orchestration
    await orchestrateBuild(userPrompt);
  });

  // Orchestration flow
  async function orchestrateBuild(userPrompt) {
    // Create project dir
    projectDir = 'buddy-project-' + puter.randName();
    fileIndex = {};
    activeFilePath = null;
    renderFileList();
    pushMessage('assistant', 'Coordinator', `<p>Creating project <strong>${projectDir}</strong> and starting multi-AI orchestration...</p>`);

    // Coordinator: decide problem decomposition
    const coordinatorModel = await chooseAvailableModel(modelCandidates.coordinator);
    if (!coordinatorModel) {
      pushMessage('assistant', 'Coordinator', `<p style="color:var(--error)">No coordinator model available.</p>`);
      return;
    }
    pushMessage('assistant', 'Coordinator', `<p>Using model <strong>${coordinatorModel}</strong> to analyze the prompt and produce tasks.</p>`);
    const coordResp = await puter.ai.chat(`You are the coordinator. The user asked: "${userPrompt}". Produce:
1) A one-sentence problem statement.
2) A short ordered list (1..5) of tasks to solve this (e.g., search resources, design structure, write files, live guidance).
3) For each task, name the preferred model from this list: [gpt-4, claude, grok, deepseek, llama] and provide a brief instruction for that model.
Output JSON with keys: problem, tasks (array of {id,title,model,instruction}).`, { model: coordinatorModel });

    // extract coordinator text (some Puter responses stream parts; handle string or object)
    const coordText = (typeof coordResp === 'string') ? coordResp : (coordResp?.text || JSON.stringify(coordResp));
    pushMessage('assistant', 'Coordinator (raw)', `<pre>${escapeHtml(coordText)}</pre>`);

    // Basic parse attempt for JSON in coordinator output
    let coordJson;
    try {
      coordJson = JSON.parse(coordText);
    } catch (e) {
      // fallback: ask coordinator to reformat strictly as JSON
      pushMessage('assistant', 'Coordinator', `<p>Coordinator output was not valid JSON. Asking to reformat.</p>`);
      const coordFix = await puter.ai.chat(`Reformat the following response strictly as JSON with keys "problem" and "tasks": ${coordText}`, { model: coordinatorModel });
      const coordFixText = typeof coordFix === 'string' ? coordFix : (coordFix?.text || JSON.stringify(coordFix));
      try { coordJson = JSON.parse(coordFixText); } catch (ee) { pushMessage('assistant','Coordinator',`<p style="color:var(--error)">Failed to parse coordinator JSON. Aborting.</p><pre>${escapeHtml(coordFixText)}</pre>`); return; }
    }

    // Now run tasks sequentially
    for (const t of coordJson.tasks) {
      pushMessage('assistant', 'Coordinator', `<p>Starting task <strong>${t.id} — ${t.title}</strong> (preferred model: ${t.model})</p>`);
      // map requested model to available candidate
      let assignedModel = await chooseAvailableModel([t.model].concat(modelCandidates[t.id] || []));
      if (!assignedModel) {
        // fallback to any available model
        assignedModel = await chooseAnyModel();
      }
      // Run the selected task instruction on the assignedModel
      pushMessage('assistant', 'Task Runner', `<p>Assigning to <strong>${assignedModel}</strong>: ${escapeHtml(t.instruction)}</p>`);
      const resp = await puter.ai.chat(t.instruction, { model: assignedModel, stream: true });

      // Stream the response into the chat and also route to appropriate handler based on task id/title
      let fullText = '';
      if (resp && Symbol.asyncIterator in resp) {
        // streaming response iterator
        for await (const part of resp) {
          const chunk = part?.text || '';
          fullText += chunk;
          // append temporary streaming block to the UI
          const streamingEl = pushMessage('assistant', `${t.title} — ${assignedModel}`, `<pre>${escapeHtml(fullText)}</pre>`);
        }
      } else {
        fullText = typeof resp === 'string' ? resp : (resp?.text || JSON.stringify(resp));
        pushMessage('assistant', `${t.title} — ${assignedModel}`, `<pre>${escapeHtml(fullText)}</pre>`);
      }

      // Handle outputs by task type hints in title or id
      const lowerTitle = (t.title || '').toLowerCase();
      if (lowerTitle.includes('search')) {
        // expect a list of URLs or resources — save to a file
        fileIndex['resources.txt'] = { name: 'resources.txt', content: fullText };
        await puter.fs.write(`${projectDir}/resources.txt`, fullText);
        pushMessage('assistant', 'Storage', `<p>Saved resources.txt</p>`);
      } else if (lowerTitle.includes('architect') || lowerTitle.includes('architecture') || lowerTitle.includes('structure')) {
        // expect JSON or a file/folder tree; create files/folders accordingly
        // parse for a simple structure: lines like "src/: index.js, app.js" or JSON { files: { "index.html": "<html>..." } }
        let created = 0;
        try {
          const parsed = JSON.parse(fullText);
          if (parsed.files) {
            for (const [p, content] of Object.entries(parsed.files)) {
              fileIndex[p] = { name: p, content: content };
              await puter.fs.write(`${projectDir}/${p}`, content);
              created++;
            }
          }
        } catch (e) {
          // fallback: simple heuristic — if output contains "index.html" and code fences, extract
          const codeBlocks = extractCodeBlocks(fullText);
          if (codeBlocks.length) {
            // if first block labelled index.html or contains <!DOCTYPE html>, store that as index.html
            for (let i=0;i<codeBlocks.length;i++) {
              const cb = codeBlocks[i];
              let suggestedName = 'file' + (i+1) + '.txt';
              if (cb.includes('<!DOCTYPE')) suggestedName = 'index.html';
              if (cb.trim().startsWith('<')) {
                suggestedName = suggestedName.replace('.txt', '.html');
              }
              fileIndex[suggestedName] = { name: suggestedName, content: cb };
              await puter.fs.write(`${projectDir}/${suggestedName}`, cb);
              created++;
            }
          }
        }
        pushMessage('assistant','Architect','<p>Created ' + created + ' files from architecture output.</p>');
      } else if (lowerTitle.includes('code') || lowerTitle.includes('coder') || lowerTitle.includes('implement')) {
        // The coder should produce files; extract code fences and write them
        const codeBlocks = extractCodeBlocks(fullText);
        let written = 0;
        if (codeBlocks.length) {
          for (const cb of codeBlocks) {
            // Heuristic to name files using first line comments or tags like "### filename: index.html"
            let fileName = inferFilenameFromCode(cb) || ('file-' + (++written) + '.txt');
            // if an index.html already exists, append -n
            if (fileIndex[fileName]) {
              fileName = fileName.replace('.', '-' + Date.now() + '.');
            }
            fileIndex[fileName] = { name: fileName, content: cb };
            await puter.fs.write(`${projectDir}/${fileName}`, cb);
            written++;
          }
        } else {
          // if coder returned raw textual project, save as project.txt
          fileIndex['project.txt'] = { name: 'project.txt', content: fullText };
          await puter.fs.write(`${projectDir}/project.txt`, fullText);
        }
        pushMessage('assistant','Coder',`<p>Wrote ${Object.keys(fileIndex).length} files. Files: ${Object.keys(fileIndex).join(', ')}</p>`);
      } else if (lowerTitle.includes('guide') || lowerTitle.includes('stream') || lowerTitle.includes('progress')) {
        // Guide messages shown already — optionally keep as log
        await puter.fs.write(`${projectDir}/guide.log`, fullText);
      } else {
        // General output — save to a task-specific file
        const safeName = t.title.replace(/[^\w\-]/g,'_').slice(0,40) + '.txt';
        fileIndex[safeName] = { name: safeName, content: fullText };
        await puter.fs.write(`${projectDir}/${safeName}`, fullText);
      }

      // render updated file list and continue
      renderFileList();
    } // end for tasks

    pushMessage('assistant', 'Coordinator', `<p>Orchestration finished. Project directory: <strong>${projectDir}</strong>. You can preview, save, or publish it.</p>`);
  }

  // Utility: try candidate models in order by making a lightweight probe call
  async function chooseAvailableModel(candidates = []) {
    for (const m of candidates) {
      try {
        // probe: short harmless prompt and small timeout
        const probe = await puter.ai.chat(`(probe) Are you model "${m}" available? Reply "yes" succinctly.`, { model: m, max_tokens: 12, timeout: 8000 });
        const text = typeof probe === 'string' ? probe : (probe?.text || '');
        if (text && /yes/i.test(text)) return m;
        // if probe returns something treat as available (some providers won't echo)
        if (text && text.length > 0) return m;
      } catch (err) {
        // model not available, try next
        console.info('Model probe failed for', m, err?.message || err);
      }
    }
    // if none matched, return null
    return null;
  }

  // choose any available model as final fallback by probing a small set
  async function chooseAnyModel() {
    const pool = ['gpt-4','gpt-4o','gpt-4.1','claude','grok','deepseek','llama'];
    return await chooseAvailableModel(pool);
  }

  // Extract triple-backtick code blocks
  function extractCodeBlocks(text) {
    const re = /```(?:[a-zA-Z0-9\-\_\.]+)?\n([\s\S]*?)```/g;
    const blocks = [];
    let m;
    while ((m = re.exec(text)) !== null) blocks.push(m[1].trim());
    // also capture html-looking full text
    if (blocks.length === 0 && /<!DOCTYPE|<html/i.test(text)) {
      blocks.push(text);
    }
    return blocks;
  }

  // Try to infer filename from code via comments or hints
  function inferFilenameFromCode(code) {
    // look for comment lines like // filename: index.html or <!-- filename: index.html -->
    const m1 = code.match(/filename:\s*([^\s]+)/i);
    if (m1) return m1[1].trim();
    const m2 = code.match(/<title>([^<]+)<\/title>/i);
    if (m2) return 'index.html';
    if (code.trim().startsWith('<')) return 'index.html';
    if (code.includes('import') && code.includes('react')) return 'app.jsx';
    return null;
  }

  // small escape helper
  function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\n','<br>'); }

  // Infer when page loads — show list of files if any
  (async function init() {
    // try to list user's root directories (requires sign-in)
    try {
      const signed = await puter.auth.isSignedIn();
      if (signed) { userSignedIn = true; signInBtn.textContent = 'Signed in'; }
    } catch (e) { console.log('init auth check failed', e); }
  })();

  </script>
</body>
</html>
